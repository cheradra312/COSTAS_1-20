<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visor de Mapas Conceptuales</title>
    <!-- Tailwind CSS para el diseño -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome para los iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .topic-button {
            background-color: #ffffff;
            border: 1px solid #d1d5db;
            color: #374151;
            padding: 1rem;
            border-radius: 0.75rem;
            text-align: left;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        .topic-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.08);
        }
        .topic-number {
            border-radius: 9999px;
            font-weight: 700;
            font-size: 1.125rem;
            width: 2.75rem;
            height: 2.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: all 0.2s ease-in-out;
        }
        .topic-title { font-weight: 600; flex-grow: 1; }
        .topic-icon { font-size: 1.25rem; width: 2rem; text-align: center; transition: color 0.2s ease-in-out; }
        #top-control-bar { display: none; opacity: 0; transition: opacity 0.3s ease-in-out; }
        
        input[type="range"]::-webkit-slider-runnable-track { background: #e5e7eb; height: 0.25rem; border-radius: 1rem; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; margin-top: -6px; background-color: #3b82f6; height: 1rem; width: 1rem; border-radius: 50%; }
        input[type="range"] { -webkit-appearance: none; appearance: none; background: transparent; cursor: pointer; }

        #play-pause-button:disabled { background-color: #9ca3af; cursor: not-allowed; transform: none; }

        .chapter-button { transition: background-color 0.2s; }
        .chapter-button.playing { background-color: #dbeafe; font-weight: 700; color: #1e3a8a; }
        
        #loop-button.active {
            color: #ffffff;
            background-color: #3b82f6;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <!-- VISTA DEL MENÚ PRINCIPAL -->
        <div id="main-menu-view">
            <header class="text-center mb-8">
                <h1 class="text-3xl md:text-4xl font-extrabold text-gray-800">Visor de Mapas Conceptuales</h1>
                <p class="text-lg text-gray-500 mt-2">Selecciona un tema para comenzar</p>
            </header>
            <div id="topics-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4"></div>
        </div>

        <!-- VISTA DEL VISOR DE MAPAS -->
        <div id="map-viewer-view" class="hidden">
            <div id="top-control-bar" class="flex justify-between items-center gap-4 mb-4">
                <button id="back-button" class="bg-white text-gray-700 font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-gray-100 flex items-center gap-2">
                    <i class="fas fa-arrow-left"></i>
                    <span class="hidden sm:inline">Volver</span>
                </button>
                <div id="audio-player" class="bg-white p-2 rounded-lg shadow-md flex items-center gap-3 relative">
                    <!-- Menú Desplegable de Capítulos -->
                    <div id="chapters-menu-container" class="relative">
                        <button id="chapters-button" class="text-gray-600 hover:bg-gray-200 rounded-full w-10 h-10 flex-shrink-0 flex items-center justify-center transition">
                            <i class="fas fa-list-ul"></i>
                        </button>
                        <div id="chapters-dropdown" class="absolute top-full mt-2 left-0 bg-white shadow-lg rounded-lg p-2 w-80 max-h-72 overflow-y-auto hidden z-10">
                            <!-- Los capítulos se insertarán aquí -->
                        </div>
                    </div>
                    
                    <button id="play-pause-button" class="text-white bg-blue-500 hover:bg-blue-600 rounded-full w-10 h-10 flex-shrink-0 flex items-center justify-center transition-transform transform hover:scale-110">
                        <i id="play-pause-icon" class="fas fa-play"></i>
                    </button>
                    <div class="flex items-center gap-2 text-xs text-gray-500">
                        <span id="current-time">00:00</span>
                        <input type="range" id="timeline-slider" class="w-24 md:w-32" value="0" step="1">
                        <span id="total-duration">00:00</span>
                    </div>
                    <div class="flex items-center gap-3">
                         <button id="loop-button" class="text-gray-500 hover:bg-gray-200 rounded-full w-9 h-9 flex-shrink-0 transition-colors">
                            <i class="fas fa-retweet"></i>
                         </button>
                         <button id="speed-button" class="text-xs font-bold text-blue-500 bg-blue-100 hover:bg-blue-200 rounded-full w-9 h-9 flex-shrink-0">1x</button>
                         <div class="hidden md:flex items-center gap-2">
                             <i id="volume-icon" class="fas fa-volume-high text-gray-500 cursor-pointer"></i>
                             <input type="range" id="volume-slider" class="w-16" min="0" max="1" step="0.05" value="1">
                         </div>
                    </div>
                </div>
            </div>
            
            <div class="bg-white p-2 rounded-xl shadow-lg border border-gray-200">
                <iframe id="content-frame" class="w-full border-0 rounded-lg" style="min-height: 80vh;" src=""></iframe>
            </div>
        </div>
        
        <audio id="topic-audio" src=""></audio>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // --- Lista de temas y capítulos ---
            const topics = [
                { file: 'MEA2T1_Desplegable.html', title: 'La Legislación de Costas', color: 'blue', icon: 'fa-gavel' },
                { file: 'MEA2T2_DESPLEGABLE.html', title: 'Bienes de Dominio Público Marítimo-Terrestre', color: 'cyan', icon: 'fa-landmark',
                  chapters: [
                      { "title": "1. Los bienes de DPMT. Clasificación y definiciones.", "start": 0, "end": 192 },
                      { "title": "2. Prevalencia del DPMT. Potestades de la administración.", "start": 182, "end": 242 },
                      { "title": "3. El deslinde del DPMT. Procedimiento.", "start": 232, "end": 543 },
                      { "title": "4. Estudios para la justificación del deslinde.", "start": 543, "end": 573 },
                      { "title": "5. Proyecto de deslinde. Efectos de la aprobación del deslinde.", "start": 573, "end": 648 },
                      { "title": "6. Inmatriculación de fincas colindantes con el DPMT. Afectación y desafectación.", "start": 638 }
                  ]
                },
                { file: 'MEA2T3_DESPLEGABLE.html', title: 'Limitaciones a la propiedad', color: 'sky', icon: 'fa-ban',
                  chapters: [
                    { "title": "1. Limitaciones a la propiedad sobre los terrenos contiguos a la ribera del mar por razones de protección del dominio público marítimo-terrestre.", "start": 0, "end": 72 },
                    { "title": "2. Servidumbres de protección, tránsito y acceso al mar. Anchura y usos permitidos.", "start": 62, "end": 435 },
                    { "title": "3. La disposición transitoria tercera de la ley 22/1988.", "start": 425, "end": 565 },
                    { "title": "4. Otras limitaciones a la propiedad. Zona de influencia.", "start": 555 }
                  ]
                },
                { file: 'MEA2T4_DESPLEGABLE.html', title: 'Utilización del DPMT', color: 'indigo', icon: 'fa-swimmer',
                  chapters: [
                    { "title": "1. Utilización del DPMT. Disposiciones generales.", "start": 0, "end": 331 },
                    { "title": "2. Proyectos y obras en el DPMT. Estudios complementarios.", "start": 321, "end": 504 },
                    { "title": "3. Reservas, adscripciones, autorización y concesiones.", "start": 494 }
                  ]
                },
                { file: 'MEA2T5_DESPLEGABLE.html', title: 'Régimen Económico-Financiero', color: 'green', icon: 'fa-coins' },
                { file: 'MEA2T6_DESPLEGABLE.html', title: 'Competencias de la AGE según la ley 22/1988', color: 'emerald', icon: 'fa-building-columns',
                  chapters: [
                    { "title": "1. Competencias de la AGE según la normativa de costas. Decretos de transferencias a las CCAA.", "start": 0, "end": 258 },
                    { "title": "2. Obras de interés general.", "start": 258, "end": 443 },
                    { "title": "3. Informes preceptivos y vinculantes.", "start": 433, "end": 531 },
                    { "title": "4. Competencias de las Comunidades Autónomas.", "start": 521, "end": 565 },
                    { "title": "5. Competencias municipales.", "start": 555 }
                  ]
                },
                { file: 'MEA2T7_DESPLEGABLE.html', title: 'Régimen Transitorio', color: 'teal', icon: 'fa-history' },
                { file: 'MEA2T8_DESPLEGABLE.html', title: 'Las autorizaciones en servidumbre de protección', color: 'lime', icon: 'fa-file-signature',
                  chapters: [
                    { "title": "1. Las autorizaciones en servidumbre de protección. Competencia.", "start": 0, "end": 334 },
                    { "title": "2. La declaración responsable. La disposición transitoria cuarta de la ley 22/1988 y su desarrollo reglamentario.", "start": 324, "end": 614 },
                    { "title": "3. Autorización de nuevos usos y construcciones conforme a los instrumentos de ordenación, fachadas marítimas.", "start": 604 }
                  ]
                },
                { file: 'MEA2T9_DESPLEGABLE.html', title: 'Biodiversidad y conservación de ecosistemas marinos y costeros', color: 'yellow', icon: 'fa-seedling',
                  chapters: [
                    { "title": "1. Biodiversidad y conservación de ecosistemas marinos y costeros.", "start": 0, "end": 173 },
                    { "title": "2. Las zonas húmedas costeras.", "start": 163, "end": 450 },
                    { "title": "3. Las zonas dunares costeras: definición y evolución en la normativa de costas.", "start": 440, "end": 546 },
                    { "title": "4. Las zonas de fanerógamas marinas. Importancia y tratamiento.", "start": 536 }
                  ]
                },
                { file: 'MEA2T10_DESPLEGABLE.html', title: 'La gestión integral del litoral', color: 'amber', icon: 'fa-tasks' },
                { file: 'MEA2T11_DESPLEGABLE.html', title: 'Las distintas teorías de ondas', color: 'orange', icon: 'fa-wave-square',
                  chapters: [
                    { "title": "1. Las distintas teorías de ondas.", "start": 0, "end": 257 },
                    { "title": "2. La propagación del oleaje. Los fenómenos de refracción, difracción, transmisión y reflexión del oleaje.", "start": 247 }
                  ]
                },
                { file: 'MEA2T12_DESPLEGABLE.html', title: 'El transporte sólido litoral', color: 'red', icon: 'fa-arrows-left-right',
                  chapters: [
                    { "title": "1. El transporte sólido litoral.", "start": 0, "end": 108 },
                    { "title": "2. Distintas formulaciones.", "start": 98, "end": 182 },
                    { "title": "3. Evolución de la línea de costa. Modelos.", "start": 172, "end": 352 },
                    { "title": "4. El perfil de playa. Distintas formulaciones teóricas.", "start": 342, "end": 482 },
                    { "title": "5. Variaciones del perfil.", "start": 472, "end": 613 },
                    { "title": "6. La profundidad de cierre.", "start": 603 }
                  ]
                },
                { file: 'MEA2T13_DESPLEGABLE.html', title: 'Los efectos del cambio climático sobre el litoral', color: 'rose', icon: 'fa-temperature-high',
                  chapters: [
                    { "title": "1. Los efectos del cambio climático sobre las dinámicas oceánicas, el litoral, los ecosistemas y los recursos marinos. Factores de degradación del litoral.", "start": 0, "end": 153 },
                    { "title": "2. Adaptación de la costa a los efectos del cambio climático.", "start": 143, "end": 259 },
                    { "title": "3. Evaluación de riesgo de inundación en zonas costeras.", "start": 249, "end": 538 },
                    { "title": "4. Efectos del cambio climático sobre la inundación costera.", "start": 528, "end": 596 },
                    { "title": "5. Las infraestructuras costeras ante los impactos del cambio climático: análisis y diseño de medidas de adaptación.", "start": 586, "end": 677 },
                    { "title": "6. Huella de carbono de los proyectos en análisis de ciclo de vida. Principales medidas en infraestructuras para contribuir a la reducción de emisiones de gases de efecto invernadero.", "start": 667 }
                  ]
                },
                { file: 'MEA2T14_DESPLEGABLE.html', title: 'Las estrategias marinas en España', color: 'pink', icon: 'fa-map' },
                { file: 'MEA2T15_DESPLEGABLE.html', title: 'La erosión en los distintos tipos de playas', color: 'fuchsia', icon: 'fa-mountain-sun',
                  chapters: [
                    { "title": "1. La erosión en los distintos tipos de playas. Causas de la erosión.", "start": 0, "end": 210 },
                    { "title": "2. Efectos de las infraestructuras litorales sobre las playas. Medidas correctoras y actuaciones.", "start": 200, "end": 616 },
                    { "title": "3. Efectos del cambio climático sobre la erosión costera.", "start": 606 }
                  ]
                },
                { file: 'MEA2T16_DESPLEGABLE.html', title: 'Proyectos de playas artificiales', color: 'purple', icon: 'fa-umbrella-beach',
                  chapters: [
                    { "title": "1. Proyectos de playas artificiales. Actuaciones en la costa.", "start": 0, "end": 329 },
                    { "title": "2. Formas de playa en planta. La espiral logarítmica y las soluciones parabólicas.", "start": 319, "end": 428 },
                    { "title": "3. La granulometría de la arena como condicionante del diseño.", "start": 418, "end": 626 },
                    { "title": "4. Aspectos ambientales de la regeneración de playas. Efectos sobre las comunidades pelágicas y bentónicas.", "start": 616 }
                  ]
                },
                { file: 'MEA2T17_DESPLEGABLE.html', title: 'Las fuentes naturales de sedimentos', color: 'violet', icon: 'fa-stream',
                  chapters: [
                    { "title": "1. Las fuentes naturales de sedimentos.", "start": 0, "end": 99 },
                    { "title": "2. Las zonas de préstamo para alimentación artificial.", "start": 89, "end": 226 },
                    { "title": "3. Aspectos ambientales de la extracción de materiales del fondo marino. Directrices para la caracterización del material de dragado y su reubicación en aguas del dominio público marítimo-terrestre.", "start": 216, "end": 515 },
                    { "title": "4. Métodos de prospección submarina.", "start": 505, "end": 667 },
                    { "title": "5. Otros métodos de prospección submarina: gravimetría, sondeos y ensayos in-situ.", "start": 657 }
                  ]
                },
                { file: 'MEA2T18_DESPLEGABLE.html', title: 'El puerto', color: 'gray', icon: 'fa-anchor',
                  chapters: [
                    { "title": "1. El puerto, aspectos generales y físicos. Objetivos y funciones.", "start": 0, "end": 43 },
                    { "title": "2. El sistema portuario español.", "start": 33, "end": 163 },
                    { "title": "3. Real Decreto Legislativo 2/2011 por el que se aprueba el TRL de puertos del Estado y de la Marina Mercante.", "start": 153, "end": 217 },
                    { "title": "4. Financiación de puertos.", "start": 207, "end": 357 },
                    { "title": "5. Modelos de gestión.", "start": 347, "end": 409 },
                    { "title": "6. Planificación portuaria. Fundamentos y planes.", "start": 399, "end": 507 },
                    { "title": "7. Previsiones de tráfico.", "start": 497, "end": 622 },
                    { "title": "8. Estudio de capacidad. Ordenación de terminales.", "start": 612 }
                  ]
                },
                { file: 'MEA2T19_DESPLEGABLE.html', title: 'Obras portuarias (II)', color: 'slate', icon: 'fa-hard-hat',
                  chapters: [
                    { "title": "1. Obras de abrigo y portuarias y definición y caracterización de la situación y factores de proyecto.", "start": 0, "end": 202 },
                    { "title": "2. Estados límite últimos. Período de retorno.", "start": 192, "end": 266 },
                    { "title": "3. Bases de datos. Clima marítimo, caracterización estadística de oleaje, parámetros.", "start": 256, "end": 583 },
                    { "title": "4. Análisis estadístico del oleaje en aguas profundas y poco profundas régimen estremales y régimen medio.", "start": 573 }
                  ]
                },
                { file: 'MEA2T20_DESPLEGABLE.html', title: 'Obras portuarias (I)', color: 'zinc', icon: 'fa-ship',
                  chapters: [
                    { "title": "1. Obras de abrigo y portuarias y diseños y dimensionamiento. Diseño en planta.", "start": 0, "end": 185 },
                    { "title": "2. Obras exteriores: Diques verticales, diques en talud, diques rebasables.", "start": 175, "end": 370 },
                    { "title": "3. Obras interiores: muelles, dársenas, amarres, fondeo.", "start": 360, "end": 535 },
                    { "title": "4. Superficies portuarias.", "start": 525, "end": 680 },
                    { "title": "5. Profundidades accesorias, maniobrabilidad de buques.", "start": 670 }
                  ]
                }
            ];
            
            const colorPalette = {
                blue: { normal: 'bg-blue-100 text-blue-800', icon: 'text-blue-500' }, cyan: { normal: 'bg-cyan-100 text-cyan-800', icon: 'text-cyan-500' }, sky: { normal: 'bg-sky-100 text-sky-800', icon: 'text-sky-500' }, indigo: { normal: 'bg-indigo-100 text-indigo-800', icon: 'text-indigo-500' }, green: { normal: 'bg-green-100 text-green-800', icon: 'text-green-500' }, emerald: { normal: 'bg-emerald-100 text-emerald-800', icon: 'text-emerald-500' }, teal: { normal: 'bg-teal-100 text-teal-800', icon: 'text-teal-500' }, lime: { normal: 'bg-lime-100 text-lime-800', icon: 'text-lime-500' }, yellow: { normal: 'bg-yellow-100 text-yellow-800', icon: 'text-yellow-500' }, amber: { normal: 'bg-amber-100 text-amber-800', icon: 'text-amber-500' }, orange: { normal: 'bg-orange-100 text-orange-800', icon: 'text-orange-500' }, red: { normal: 'bg-red-100 text-red-800', icon: 'text-red-500' }, rose: { normal: 'bg-rose-100 text-rose-800', icon: 'text-rose-500' }, pink: { normal: 'bg-pink-100 text-pink-800', icon: 'text-pink-500' }, fuchsia: { normal: 'bg-fuchsia-100 text-fuchsia-800', icon: 'text-fuchsia-500' }, purple: { normal: 'bg-purple-100 text-purple-800', icon: 'text-purple-500' }, violet: { normal: 'bg-violet-100 text-violet-800', icon: 'text-violet-500' }, gray: { normal: 'bg-gray-100 text-gray-800', icon: 'text-gray-500' }, slate: { normal: 'bg-slate-100 text-slate-800', icon: 'text-slate-500' }, zinc: { normal: 'bg-zinc-100 text-zinc-800', icon: 'text-zinc-500' }
            };

            const gridContainer = document.getElementById('topics-grid');
            const mainMenuView = document.getElementById('main-menu-view');
            const mapViewerVIew = document.getElementById('map-viewer-view');
            const backButton = document.getElementById('back-button');
            const iframe = document.getElementById('content-frame');
            const topControlBar = document.getElementById('top-control-bar');
            const chaptersMenuContainer = document.getElementById('chapters-menu-container');
            const chaptersButton = document.getElementById('chapters-button');
            const chaptersDropdown = document.getElementById('chapters-dropdown');
            const topicAudio = document.getElementById('topic-audio');
            const playPauseButton = document.getElementById('play-pause-button');
            const playPauseIcon = document.getElementById('play-pause-icon');
            const timelineSlider = document.getElementById('timeline-slider');
            const currentTimeEl = document.getElementById('current-time');
            const totalDurationEl = document.getElementById('total-duration');
            const speedButton = document.getElementById('speed-button');
            const loopButton = document.getElementById('loop-button');
            const volumeSlider = document.getElementById('volume-slider');
            const volumeIcon = document.getElementById('volume-icon');
            
            let currentChapterEndTime = null;
            let currentChapterStartTime = null;

            topics.forEach((topic, index) => {
                const button = document.createElement('button');
                const colors = colorPalette[topic.color];
                button.className = 'topic-button';
                button.dataset.index = index;
                button.innerHTML = `<span class="topic-number ${colors.normal}">${index + 1}</span><i class="fas ${topic.icon} topic-icon ${colors.icon}"></i><span class="topic-title">${topic.title}</span>`;
                gridContainer.appendChild(button);
            });

            function updateChapters(topic) {
                chaptersDropdown.innerHTML = '';
                if (topic.chapters && topic.chapters.length > 0) {
                    topic.chapters.forEach(chapter => {
                        const chapterButton = document.createElement('button');
                        chapterButton.className = 'chapter-button w-full text-left p-2 rounded hover:bg-gray-100 text-sm';
                        chapterButton.textContent = chapter.title;
                        chapterButton.dataset.start = chapter.start;
                        if(chapter.end !== undefined) {
                           chapterButton.dataset.end = chapter.end;
                        }
                        chaptersDropdown.appendChild(chapterButton);
                    });
                    chaptersMenuContainer.classList.remove('hidden');
                } else {
                    chaptersMenuContainer.classList.add('hidden');
                }
            }
            
            function showMapView(button) {
                playPauseButton.disabled = false;
                playPauseIcon.className = 'fas fa-play';
                const topicIndex = button.dataset.index;
                const selectedTopic = topics[topicIndex];
                
                mainMenuView.classList.add('hidden');
                mapViewerVIew.classList.remove('hidden');
                iframe.src = selectedTopic.file;
                topicAudio.src = `audios/${selectedTopic.file.replace(/_desplegable\.html$/i, '.mp3')}`;
                
                updateChapters(selectedTopic);
                
                topControlBar.style.display = 'flex';
                setTimeout(() => topControlBar.style.opacity = 1, 10);
            }

            function showMainMenu() {
                mapViewerVIew.classList.add('hidden');
                mainMenuView.classList.remove('hidden');
                topicAudio.pause();
                iframe.src = '';
                topControlBar.style.opacity = 0;
                setTimeout(() => topControlBar.style.display = 'none', 300);
            }

            gridContainer.addEventListener('click', (e) => e.target.closest('.topic-button') && showMapView(e.target.closest('.topic-button')));
            backButton.addEventListener('click', showMainMenu);

            const formatTime = (time) => !isNaN(time) ? `${String(Math.floor(time/60)).padStart(2,'0')}:${String(Math.floor(time%60)).padStart(2,'0')}` : "00:00";
            
            topicAudio.addEventListener('loadedmetadata', () => { totalDurationEl.textContent = formatTime(topicAudio.duration); timelineSlider.max = topicAudio.duration; });
            topicAudio.addEventListener('error', () => { playPauseButton.disabled = true; playPauseIcon.className = 'fas fa-times'; totalDurationEl.textContent = "Error"; });
            
            playPauseButton.addEventListener('click', () => { currentChapterEndTime = null; currentChapterStartTime = null; topicAudio.paused ? topicAudio.play() : topicAudio.pause(); });
            topicAudio.addEventListener('play', () => playPauseIcon.classList.replace('fa-play', 'fa-pause'));
            topicAudio.addEventListener('pause', () => playPauseIcon.classList.replace('fa-pause', 'fa-play'));
            topicAudio.addEventListener('ended', () => {
                 if (topicAudio.loop && currentChapterStartTime === null) {
                    // Loop for the whole audio
                 } else if (topicAudio.loop && currentChapterStartTime !== null) {
                    // This case is handled in 'timeupdate'
                 } else {
                    playPauseIcon.classList.replace('fa-pause', 'fa-play');
                 }
            });

            topicAudio.addEventListener('timeupdate', () => {
                timelineSlider.value = topicAudio.currentTime;
                currentTimeEl.textContent = formatTime(topicAudio.currentTime);
                if (currentChapterEndTime && topicAudio.currentTime >= currentChapterEndTime) {
                    if (topicAudio.loop) {
                        topicAudio.currentTime = currentChapterStartTime;
                        topicAudio.play();
                    } else {
                        topicAudio.pause();
                        currentChapterEndTime = null;
                        currentChapterStartTime = null;
                        document.querySelector('.chapter-button.playing')?.classList.remove('playing');
                    }
                }
            });

            timelineSlider.addEventListener('input', () => { currentChapterEndTime = null; currentChapterStartTime = null; topicAudio.currentTime = timelineSlider.value; });

            chaptersButton.addEventListener('click', (e) => {
                e.stopPropagation();
                chaptersDropdown.classList.toggle('hidden');
            });

            chaptersDropdown.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON') {
                    document.querySelector('.chapter-button.playing')?.classList.remove('playing');
                    e.target.classList.add('playing');
                    currentChapterStartTime = parseFloat(e.target.dataset.start);
                    currentChapterEndTime = e.target.dataset.end ? parseFloat(e.target.dataset.end) : null;
                    topicAudio.currentTime = currentChapterStartTime;
                    topicAudio.play();
                    chaptersDropdown.classList.add('hidden');
                }
            });

            const speeds = [1, 1.25, 1.5, 2];
            let currentSpeedIndex = 0;
            speedButton.addEventListener('click', () => {
                currentSpeedIndex = (currentSpeedIndex + 1) % speeds.length;
                topicAudio.playbackRate = speeds[currentSpeedIndex];
                speedButton.textContent = `${speeds[currentSpeedIndex]}x`;
            });

            loopButton.addEventListener('click', () => {
                topicAudio.loop = !topicAudio.loop;
                loopButton.classList.toggle('active');
            });

            volumeSlider.addEventListener('input', (e) => topicAudio.volume = e.target.value);
            topicAudio.addEventListener('volumechange', () => {
                volumeSlider.value = topicAudio.volume;
                volumeIcon.className = topicAudio.muted || topicAudio.volume === 0 ? "fas fa-volume-mute text-gray-500" : topicAudio.volume < 0.5 ? "fas fa-volume-low text-gray-500" : "fas fa-volume-high text-gray-500";
            });
            volumeIcon.addEventListener('click', () => topicAudio.muted = !topicAudio.muted);
            
            document.addEventListener('click', (e) => {
                if (!chaptersMenuContainer.contains(e.target)) {
                    chaptersDropdown.classList.add('hidden');
                }
            });
        });
    </script>
</body>
</html>
