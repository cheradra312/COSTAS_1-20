<!DOCTYPE html> 
 <html lang="es"> 
 <head> 
 	<meta charset="UTF-8"> 
 	<meta name="viewport" content="width=device-width, initial-scale=1.0"> 
 	<title>Visor de Mapas Conceptuales con Editor</title> 
 	<!-- Tailwind CSS --> 
 	<script src="https://cdn.tailwindcss.com"></script> 
 	<!-- Font Awesome --> 
 	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"> 
 	<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet"> 
    <!-- PDF.js Library (Version Locked for stability) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>

 	<style> 
 		body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; } 
 		.topic-button { background-color: #ffffff; border: 1px solid #d1d5db; color: #374151; padding: 1rem; border-radius: 0.75rem; text-align: left; transition: all 0.2s ease-in-out; cursor: pointer; display: flex; align-items: center; gap: 0.75rem; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); } 
 		.topic-button:hover { transform: translateY(-3px); box-shadow: 0 6px 16px rgba(0, 0, 0, 0.08); } 
 		.topic-number { border-radius: 9999px; font-weight: 700; font-size: 1.125rem; width: 2.75rem; height: 2.75rem; display: flex; align-items: center; justify-content: center; flex-shrink: 0; transition: all 0.2s ease-in-out; } 
 		.topic-title { font-weight: 600; flex-grow: 1; } 
 		.topic-icon { font-size: 1.25rem; width: 2rem; text-align: center; transition: color 0.2s ease-in-out; } 
 		#top-control-bar, #editor-panel { display: none; opacity: 0; transition: opacity 0.3s ease-in-out; } 
 		input[type="range"]::-webkit-slider-runnable-track { background: #e5e7eb; height: 0.25rem; border-radius: 1rem; } 
 		input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; margin-top: -6px; background-color: #3b82f6; height: 1rem; width: 1rem; border-radius: 50%; } 
 		input[type="range"] { -webkit-appearance: none; appearance: none; background: transparent; cursor: pointer; } 
 		#play-pause-button:disabled { background-color: #9ca3af; cursor: not-allowed; transform: none; } 
 		.chapter-button.playing, .edit-chapter-item.active { background-color: #dbeafe; font-weight: 700; color: #1e3a8a; } 
 		#loop-button.active { color: #ffffff; background-color: #3b82f6; } 
 		#edit-mode-toggle { -webkit-appearance: none; appearance: none; height: 1.25rem; width: 2.25rem; } 
 		#edit-mode-toggle:checked::after { transform: translateX(1rem); } 
 		#edit-mode-toggle::after { content: ''; display: inline-block; width: 1rem; height: 1rem; border-radius: 50%; background: white; transition: transform 0.2s ease-in-out; box-shadow: 0 1px 3px rgba(0,0,0,0.2); } 
 		.modal-overlay { transition: opacity 0.3s ease-in-out; } 
 	</style> 
 </head> 
 <body class="p-2 md:p-4"> 

 	<div class="mx-auto"> 
 		<!-- VISTA DEL MENÚ PRINCIPAL --> 
 		<div id="main-menu-view"> 
 			<header class="text-center mb-8 relative"> 
 				<h1 class="text-3xl md:text-4xl font-extrabold text-gray-800">Visor de Mapas Conceptuales</h1> 
 				<p class="text-lg text-gray-500 mt-2">Selecciona un tema para comenzar</p> 
                <button id="change-session-button" class="absolute top-0 right-0 bg-gray-200 text-gray-800 px-3 py-1 rounded-md hover:bg-gray-300 text-xs">Cambiar Sesión</button>
 			</header> 
 			<div id="topics-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4"></div> 
 		</div> 

 		<!-- VISTA DEL VISOR DE MAPAS --> 
 		<div id="map-viewer-view" class="hidden"> 
 			<div id="top-control-bar" class="flex justify-between items-center gap-4 mb-4"> 
 				<button id="back-button" class="bg-white text-gray-700 font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-gray-100 flex items-center gap-2"> 
 					<i class="fas fa-arrow-left"></i><span class="hidden sm:inline">Volver</span> 
 				</button> 
 				<div class="flex items-center gap-2"> 
					<button id="toggle-video-button" class="bg-red-500 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-red-600 flex items-center gap-2">
                        <i class="fas fa-video"></i><span class="hidden sm:inline">Ver Vídeo</span>
                    </button>
                    <button id="toggle-oral-pdf-button" class="bg-green-500 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-green-600 flex items-center gap-2">
                        <i class="fas fa-question-circle"></i><span class="hidden sm:inline">Preguntas Oral</span>
                    </button>
					<button id="toggle-pdf-button" class="bg-purple-500 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-purple-600 flex items-center gap-2">
                        <i class="fas fa-file-pdf"></i><span class="hidden sm:inline">Ver PDF</span>
                    </button>
 					<div class="flex items-center gap-2 bg-white px-3 py-1.5 rounded-lg shadow-md"> 
 						<label for="edit-mode-toggle" class="text-sm font-medium text-gray-700">Editar</label> 
 						<input type="checkbox" id="edit-mode-toggle" class="h-5 w-9 -checked:after:translate-x-full relative inline-flex cursor-pointer items-center rounded-full bg-gray-300 transition checked:bg-blue-500"> 
 					</div> 
 					<div id="audio-player" class="bg-white p-2 rounded-lg shadow-md flex items-center gap-3 relative"> 
 						<div id="chapters-menu-container" class="relative"> 
 							<button id="chapters-button" class="text-gray-600 hover:bg-gray-200 rounded-full w-10 h-10 flex-shrink-0 flex items-center justify-center transition"><i class="fas fa-list-ul"></i></button> 
 							<div id="chapters-dropdown" class="absolute top-full mt-2 right-0 md:left-0 bg-white shadow-lg rounded-lg p-2 w-80 max-h-72 overflow-y-auto hidden z-10"></div> 
 						</div>
 						<button id="rewind-button" title="Retroceder 3s" class="text-gray-600 hover:bg-gray-200 rounded-full w-10 h-10 flex-shrink-0 flex items-center justify-center transition"><i class="fas fa-undo-alt"></i></button>
 						<button id="play-pause-button" class="text-white bg-blue-500 hover:bg-blue-600 rounded-full w-10 h-10 flex-shrink-0 flex items-center justify-center transition-transform transform hover:scale-110"><i id="play-pause-icon" class="fas fa-play"></i></button> 
 						<button id="forward-button" title="Adelantar 3s" class="text-gray-600 hover:bg-gray-200 rounded-full w-10 h-10 flex-shrink-0 flex items-center justify-center transition"><i class="fas fa-redo-alt"></i></button>
 						<div class="flex items-center gap-2 text-xs text-gray-500"><span id="current-time">00:00</span><input type="range" id="timeline-slider" class="w-24 md:w-32" value="0" step="1"><span id="total-duration">00:00</span></div> 
 						<div class="flex items-center gap-3">
 							<button id="loop-button" class="text-gray-500 hover:bg-gray-200 rounded-full w-9 h-9 flex-shrink-0 transition-colors"><i class="fas fa-retweet"></i></button>
 							<button id="speed-button" class="text-xs font-bold text-blue-500 bg-blue-100 hover:bg-blue-200 rounded-full w-9 h-9 flex-shrink-0">1x</button>
 						</div> 
 					</div> 
 				</div> 
 			</div> 

 			<div class="flex flex-col lg:flex-row gap-4"> 
 				<div id="editor-panel" class="w-full lg:w-1/3 bg-white p-4 rounded-lg shadow-lg border border-gray-200 hidden"> 
 					<div class="flex justify-between items-center border-b pb-2 mb-2">
 						<h3 class="font-bold text-lg">Editor de Capítulos</h3>
 						<button id="restore-defaults-button" title="Restaurar valores por defecto" class="text-sm bg-amber-500 text-white font-bold p-2 rounded-md hover:bg-amber-600 flex items-center gap-2">
 							<i class="fas fa-undo"></i>Restaurar
 						</button>
 					</div>
 					<div id="editor-list" class="space-y-2 max-h-[60vh] overflow-y-auto pr-2"></div> 
 					<div class="mt-4 flex gap-2"> 
 						<input type="text" id="new-chapter-title-input" placeholder="Título del nuevo epígrafe" class="flex-grow p-2 border rounded-md text-sm"> 
 						<button id="add-chapter-button" class="bg-indigo-500 text-white font-bold p-2 rounded-md hover:bg-indigo-600"> 
 							<i class="fas fa-plus"></i> 
 						</button> 
 					</div> 
 					<button id="save-data-button" class="mt-2 w-full bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 flex items-center justify-center gap-2"> 
 						<i id="save-icon" class="fas fa-cloud-upload-alt"></i><span id="save-text">Guardar en la Nube</span> 
 					</button> 
 					<p id="save-notification" class="text-center text-green-700 font-semibold mt-2 opacity-0 transition-opacity">¡Guardado!</p> 
 				</div> 
                <div id="content-container" class="flex-1">
                    <iframe id="content-frame" class="w-full h-full border-0 rounded-xl shadow-lg" style="min-height: 90vh;" src=""></iframe>
                    <div id="pdf-viewer-container" class="hidden flex-1 transition-all duration-300 bg-gray-200 p-2 sm:p-4 flex-col items-center relative rounded-lg" style="min-height: 90vh;">
                        <div id="pdf-controls" class="mb-2 sm:mb-4 bg-white p-2 rounded-lg shadow-md flex items-center gap-2 sm:gap-4 z-10">
                            <button id="prev-page" class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 disabled:bg-gray-400"><i class="fas fa-arrow-left"></i></button>
                            <span class="text-sm sm:text-base">Página <span id="page-num">0</span> de <span id="page-count">0</span></span>
                            <button id="next-page" class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 disabled:bg-gray-400"><i class="fas fa-arrow-right"></i></button>
                        </div>
                        <div id="pdf-render-area" class="overflow-auto flex-grow w-full flex justify-center">
                             <canvas id="pdf-canvas" class="border-2 border-gray-400 shadow-lg"></canvas>
                        </div>
                         <div id="pdf-loading-overlay" class="absolute inset-0 bg-white bg-opacity-80 flex-col items-center justify-center hidden z-20 rounded-lg">
                            <div class="text-center">
                                <i class="fas fa-spinner fa-spin text-4xl text-blue-500"></i>
                                <p id="loading-text" class="mt-2 text-lg font-semibold">Cargando PDF...</p>
                            </div>
                        </div>
                    </div>
                    <div id="oral-pdf-viewer-container" class="hidden flex-1 transition-all duration-300 bg-gray-200 p-2 sm:p-4 flex-col items-center relative rounded-lg" style="min-height: 90vh;">
                        <div id="oral-pdf-controls" class="mb-2 sm:mb-4 bg-white p-2 rounded-lg shadow-md flex items-center gap-2 sm:gap-4 z-10">
                            <button id="oral-prev-page" class="px-3 py-1 bg-green-500 text-white rounded hover:bg-green-600 disabled:bg-gray-400"><i class="fas fa-arrow-left"></i></button>
                            <span class="text-sm sm:text-base">Página <span id="oral-page-num">0</span> de <span id="oral-page-count">0</span></span>
                            <button id="oral-next-page" class="px-3 py-1 bg-green-500 text-white rounded hover:bg-green-600 disabled:bg-gray-400"><i class="fas fa-arrow-right"></i></button>
                        </div>
                        <div id="oral-pdf-render-area" class="overflow-auto flex-grow w-full flex justify-center">
                             <canvas id="oral-pdf-canvas" class="border-2 border-gray-400 shadow-lg"></canvas>
                        </div>
                         <div id="oral-pdf-loading-overlay" class="absolute inset-0 bg-white bg-opacity-80 flex-col items-center justify-center hidden z-20 rounded-lg">
                            <div class="text-center">
                                <i class="fas fa-spinner fa-spin text-4xl text-green-500"></i>
                                <p id="oral-loading-text" class="mt-2 text-lg font-semibold">Cargando PDF de Preguntas...</p>
                            </div>
                        </div>
                    </div>
                </div>
 			</div> 
 		</div> 
 		 
        <!-- MODAL DE SESIÓN -->
        <div id="session-modal-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-90 flex items-center justify-center z-50 modal-overlay">
            <div class="bg-white p-6 rounded-lg shadow-2xl w-full max-w-sm text-center">
                <h2 class="text-lg font-bold mb-4">ID de Sesión</h2>
                <p class="text-sm text-gray-600 mb-2">Introduce un ID para sincronizar tus datos entre dispositivos. Usa el mismo ID en todos tus aparatos.</p>
                <input type="text" id="session-id-input" class="w-full border border-gray-300 p-2 rounded-md mb-2" value="cheradra">
                <button id="start-session-button" class="w-full bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600">Comenzar</button>
            </div>
        </div>

 		<div id="password-modal-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 modal-overlay"> 
 			<div class="bg-white p-6 rounded-lg shadow-2xl w-full max-w-sm"> 
 				<h2 class="text-lg font-bold mb-4">Modo Edición Protegido</h2> 
 				<p class="text-sm text-gray-600 mb-2">Introduce la contraseña para continuar.</p> 
 				<input type="password" id="password-input" class="w-full border border-gray-300 p-2 rounded-md mb-2"> 
 				<p id="password-error" class="text-red-500 text-xs hidden mb-4">Contraseña incorrecta.</p> 
 				<div class="flex justify-end gap-2"> 
 					<button id="cancel-edit-button" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-300">Cancelar</button> 
 					<button id="confirm-edit-button" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600">Aceptar</button> 
 				</div> 
 			</div> 
 		</div> 
 		
 		<audio id="topic-audio" src=""></audio> 
 	</div> 

 	<!-- Firebase SDKs --> 
 	<script type="module"> 
 		import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"; 
 		import { getAuth } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js"; 
 		import { getFirestore, doc, getDoc, setDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"; 
 		 
 		document.addEventListener('DOMContentLoaded', async function () { 
            pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js`;

 			const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'; 
 			let db, auth, userId, currentTopic; 
 			let currentChapterEndTime=null, currentChapterStartTime=null, editedChapters=[]; 
 			let userCustomChapters = {};
            let pdfDoc = null, currentPageNum = 1;
            let oralPdfDoc = null, oralCurrentPageNum = 1;

 			function initializeFirebase() { 
 				let firebaseConfig; 
 				try { 
 					firebaseConfig = { 
 						apiKey: "AIzaSyCKXzSmQ9F1M4W59Vyalu3CWdKFsh7dOmE", 
 						authDomain: "costas-304b9.firebaseapp.com", 
 						projectId: "costas-304b9", 
 						storageBucket: "costas-304b9.appspot.com", 
 						messagingSenderId: "251850800414", 
 						appId: "1:251850800414:web:435e20e5305881732e5d0f", 
 						measurementId: "G-C2NTL72PZH" 
 					}; 
 					if (typeof __firebase_config !== 'undefined' && __firebase_config) { 
 						const envConfig = JSON.parse(__firebase_config); 
 						if (envConfig.projectId) firebaseConfig = envConfig; 
 					} 
 				} catch (e) { console.error("Firebase config parsing error:", e); } 
 				 
 				const app = initializeApp(firebaseConfig); 
 				auth = getAuth(app); 
 				db = getFirestore(app);
 			} 
 			 
            function handleSession() {
                const sessionId = localStorage.getItem('sessionId');
                if (sessionId) {
                    userId = sessionId;
                    document.getElementById('session-modal-overlay').classList.add('hidden');
                    loadAllCustomChapters();
                } else {
                    document.getElementById('session-modal-overlay').classList.remove('hidden');
                }
            }

 			async function loadAllCustomChapters() {
 				if (!userId) return;
 				const userDocRef = doc(db, `artifacts/${appId}/public/data/sessions`, userId);
 				try {
 					const docSnap = await getDoc(userDocRef);
 					if (docSnap.exists()) {
                        userCustomChapters = docSnap.data();
                    } else {
                        userCustomChapters = {};
                    }
 				} catch (error) {
 					console.error("Error loading all custom chapters:", error);
 				}
 			}
 			 
 			initializeFirebase(); 
            handleSession();

 			const topics = [ 
 				{ file: 'MEA2T1_Desplegable.html', title: 'La Legislación de Costas', color: 'blue', icon: 'fa-gavel', videoId: '10ppnvLhwAynESlCfbS5_4uQ-NXZGG-95' }, 
 				{ file: 'MEA2T2_DESPLEGABLE.html', title: 'Bienes de Dominio Público Marítimo-Terrestre', color: 'cyan', icon: 'fa-landmark', videoId: '1lg4H_WbDJ0RoDYdMjkn6G6bqkFREXmNd',
 					chapters: [ 
 						{ "title": "1. Los bienes de DPMT. Clasificación y definiciones.", "start": 0, "end": 192 }, 
 						{ "title": "2. Prevalencia del DPMT. Potestades de la administración.", "start": 182, "end": 242 }, 
 						{ "title": "3. El deslinde del DPMT. Procedimiento.", "start": 232, "end": 543 }, 
 						{ "title": "4. Estudios para la justificación del deslinde.", "start": 543, "end": 573 }, 
 						{ "title": "5. Proyecto de deslinde. Efectos de la aprobación del deslinde.", "start": 573, "end": 648 }, 
 						{ "title": "6. Inmatriculación de fincas colindantes con el DPMT. Afectación y desafectación.", "start": 638 } 
 					] 
 				}, 
 				{ file: 'MEA2T3_DESPLEGABLE.html', title: 'Limitaciones a la propiedad', color: 'sky', icon: 'fa-ban', videoId: '1rKqxjOXsAwolu1esGvpDKd-ERa8d0ovs',
 					chapters: [ 
 						{ "title": "1. Limitaciones a la propiedad sobre los terrenos contiguos a la ribera del mar por razones de protección del dominio público marítimo-terrestre.", "start": 0, "end": 72 }, 
 						{ "title": "2. Servidumbres de protección, tránsito y acceso al mar. Anchura y usos permitidos.", "start": 62, "end": 435 }, 
 						{ "title": "3. La disposición transitoria tercera de la ley 22/1988.", "start": 425, "end": 565 }, 
 						{ "title": "4. Otras limitaciones a la propiedad. Zona de influencia.", "start": 555 } 
 					] 
 				}, 
 				{ file: 'MEA2T4_DESPLEGABLE.html', title: 'Utilización del DPMT', color: 'indigo', icon: 'fa-swimmer', videoId: '1DvLX3eJMn3BBNLnqvx3zHqY8XnsgSTPh',
 					chapters: [ 
 						{ "title": "1. Utilización del DPMT. Disposiciones generales.", "start": 0, "end": 325.41 }, 
 						{ "title": "2. Proyectos y obras en el DPMT. Estudios complementarios.", "start": 325.41, "end": 497.28 }, 
 						{ "title": "3. Reservas, adscripciones, autorización y concesiones.", "start": 497.28 } 
 					] 
 				}, 
 				{ file: 'MEA2T5_DESPLEGABLE.html', title: 'Régimen Económico-Financiero', color: 'green', icon: 'fa-coins', videoId: '1DvLX3eJMn3BBNLnqvx3zHqY8XnsgSTPh' }, 
 				{ file: 'MEA2T6_DESPLEGABLE.html', title: 'Competencias de la AGE según la ley 22/1988', color: 'emerald', icon: 'fa-building-columns', videoId: '1gYr5dobAz5tWr1YnE7gLh_M-XdezcTWL',
 					chapters: [ 
 						{ "title": "1. Competencias de la AGE según la normativa de costas. Decretos de transferencias a las CCAA.", "start": 0, "end": 258 }, 
 						{ "title": "2. Obras de interés general.", "start": 258, "end": 443 }, 
 						{ "title": "3. Informes preceptivos y vinculantes.", "start": 433, "end": 531 }, 
 						{ "title": "4. Competencias de las Comunidades Autónomas.", "start": 521, "end": 565 }, 
 						{ "title": "5. Competencias municipales.", "start": 555 } 
 					] 
 				}, 
 				{ file: 'MEA2T7_DESPLEGABLE.html', title: 'Régimen Transitorio', color: 'teal', icon: 'fa-history', videoId: '1gYr5dobAz5tWr1YnE7gLh_M-XdezcTWL' }, 
 				{ file: 'MEA2T8_DESPLEGABLE.html', title: 'Las autorizaciones en servidumbre de protección', color: 'lime', icon: 'fa-file-signature', videoId: '18Oc5u4JTO5usY1yJsSxZj7oZxsvDRATA',
 					chapters: [ 
 						{ "title": "1. Las autorizaciones en servidumbre de protección. Competencia.", "start": 0, "end": 334 }, 
 						{ "title": "2. La declaración responsable. La disposición transitoria cuarta de la ley 22/1988 y su desarrollo reglamentario.", "start": 324, "end": 614 }, 
 						{ "title": "3. Autorización de nuevos usos y construcciones conforme a los instrumentos de ordenación, fachadas marítimas.", "start": 604 } 
 					] 
 				}, 
 				{ file: 'MEA2T9_DESPLEGABLE.html', title: 'Biodiversidad y conservación de ecosistemas marinos y costeros', color: 'yellow', icon: 'fa-seedling', videoId: '1x1si3GdJSg0wmxX6cEaPeTx4OAHNPemP',
 					chapters: [ 
 						{ "title": "1. Biodiversidad y conservación de ecosistemas marinos y costeros.", "start": 0, "end": 173 }, 
 						{ "title": "2. Las zonas húmedas costeras.", "start": 163, "end": 450 }, 
 						{ "title": "3. Las zonas dunares costeras: definición y evolución en la normativa de costas.", "start": 440, "end": 546 }, 
 						{ "title": "4. Las zonas de fanerógamas marinas. Importancia y tratamiento.", "start": 536 } 
 					] 
 				}, 
 				{ file: 'MEA2T10_DESPLEGABLE.html', title: 'La gestión integral del litoral', color: 'amber', icon: 'fa-tasks', videoId: '1x1si3GdJSg0wmxX6cEaPeTx4OAHNPemP' }, 
 				{ file: 'MEA2T11_DESPLEGABLE.html', title: 'Las distintas teorías de ondas', color: 'orange', icon: 'fa-wave-square', videoId: '1x1si3GdJSg0wmxX6cEaPeTx4OAHNPemP',
 					chapters: [ 
 						{ "title": "1. Las distintas teorías de ondas.", "start": 0, "end": 257 }, 
 						{ "title": "2. La propagación del oleaje. Los fenómenos de refracción, difracción, transmisión y reflexión del oleaje.", "start": 247 } 
 					] 
 				}, 
 				{ file: 'MEA2T12_DESPLEGABLE.html', title: 'El transporte sólido litoral', color: 'red', icon: 'fa-arrows-left-right', videoId: '1x1si3GdJSg0wmxX6cEaPeTx4OAHNPemP',
 					chapters: [ 
 						{ "title": "1. El transporte sólido litoral.", "start": 0, "end": 108 }, 
 						{ "title": "2. Distintas formulaciones.", "start": 98, "end": 182 }, 
 						{ "title": "3. Evolución de la línea de costa. Modelos.", "start": 172, "end": 352 }, 
 						{ "title": "4. El perfil de playa. Distintas formulaciones teóricas.", "start": 342, "end": 482 }, 
 						{ "title": "5. Variaciones del perfil.", "start": 472, "end": 613 }, 
 						{ "title": "6. La profundidad de cierre.", "start": 603 } 
 					] 
 				}, 
 				{ file: 'MEA2T13_DESPLEGABLE.html', title: 'Los efectos del cambio climático sobre el litoral', color: 'rose', icon: 'fa-temperature-high', videoId: '1W-dLzHt7Ngj1ZefDJOF3OOyG09oYj2H-',
 					chapters: [ 
 						{ "title": "1. Los efectos del cambio climático sobre las dinámicas oceánicas, el litoral, los ecosistemas y los recursos marinos. Factores de degradación del litoral.", "start": 0, "end": 153 }, 
 						{ "title": "2. Adaptación de la costa a los efectos del cambio climático.", "start": 143, "end": 259 }, 
 						{ "title": "3. Evaluación de riesgo de inundación en zonas costeras.", "start": 249, "end": 538 }, 
 						{ "title": "4. Efectos del cambio climático sobre la inundación costera.", "start": 528, "end": 596 }, 
 						{ "title": "5. Las infraestructuras costeras ante los impactos del cambio climático: análisis y diseño de medidas de adaptación.", "start": 586, "end": 677 }, 
 						{ "title": "6. Huella de carbono de los proyectos en análisis de ciclo de vida. Principales medidas en infraestructuras para contribuir a la reducción de emisiones de gases de efecto invernadero.", "start": 667 } 
 					] 
 				}, 
 				{ file: 'MEA2T14_DESPLEGABLE.html', title: 'Las estrategias marinas en España', color: 'pink', icon: 'fa-map', videoId: '1W-dLzHt7Ngj1ZefDJOF3OOyG09oYj2H-' }, 
 				{ file: 'MEA2T15_DESPLEGABLE.html', title: 'La erosión en los distintos tipos de playas', color: 'fuchsia', icon: 'fa-mountain-sun', videoId: '1yFk8qzQKyalZS6EGsncySfbqGuz9vd08',
 					chapters: [ 
 						{ "title": "1. La erosión en los distintos tipos de playas. Causas de la erosión.", "start": 0, "end": 210 }, 
 						{ "title": "2. Efectos de las infraestructuras litorales sobre las playas. Medidas correctoras y actuaciones.", "start": 200, "end": 616 }, 
 						{ "title": "3. Efectos del cambio climático sobre la erosión costera.", "start": 606 } 
 					] 
 				}, 
 				{ file: 'MEA2T16_DESPLEGABLE.html', title: 'Proyectos de playas artificiales', color: 'purple', icon: 'fa-umbrella-beach', videoId: '1yFk8qzQKyalZS6EGsncySfbqGuz9vd08',
 					chapters: [ 
 						{ "title": "1. Proyectos de playas artificiales. Actuaciones en la costa.", "start": 0, "end": 329 }, 
 						{ "title": "2. Formas de playa en planta. La espiral logarítmica y las soluciones parabólicas.", "start": 319, "end": 428 }, 
 						{ "title": "3. La granulometría de la arena como condicionante del diseño.", "start": 418, "end": 626 }, 
 						{ "title": "4. Aspectos ambientales de la regeneración de playas. Efectos sobre las comunidades pelágicas y bentónicas.", "start": 616 } 
 					] 
 				}, 
 				{ file: 'MEA2T17_DESPLEGABLE.html', title: 'Las fuentes naturales de sedimentos', color: 'violet', icon: 'fa-stream', videoId: '1yFk8qzQKyalZS6EGsncySfbqGuz9vd08',
 					chapters: [ 
 						{ "title": "1. Las fuentes naturales de sedimentos.", "start": 0, "end": 99 }, 
 						{ "title": "2. Las zonas de préstamo para alimentación artificial.", "start": 89, "end": 226 }, 
 						{ "title": "3. Aspectos ambientales de la extracción de materiales del fondo marino. Directrices para la caracterización del material de dragado y su reubicación en aguas del dominio público marítimo-terrestre.", "start": 216, "end": 515 }, 
 						{ "title": "4. Métodos de prospección submarina.", "start": 505, "end": 667 }, 
 						{ "title": "5. Otros métodos de prospección submarina: gravimetría, sondeos y ensayos in-situ.", "start": 657 } 
 					] 
 				}, 
 				{ file: 'MEA2T18_DESPLEGABLE.html', title: 'El puerto', color: 'gray', icon: 'fa-anchor', videoId: '1yFk8qzQKyalZS6EGsncySfbqGuz9vd08',
 					chapters: [ 
 						{ "title": "1. El puerto, aspectos generales y físicos. Objetivos y funciones.", "start": 0, "end": 43 }, 
 						{ "title": "2. El sistema portuario español.", "start": 33, "end": 163 }, 
 						{ "title": "3. Real Decreto Legislativo 2/2011 por el que se aprueba el TRL de puertos del Estado y de la Marina Mercante.", "start": 153, "end": 217 }, 
 						{ "title": "4. Financiación de puertos.", "start": 207, "end": 357 }, 
 						{ "title": "5. Modelos de gestión.", "start": 347, "end": 409 }, 
 						{ "title": "6. Planificación portuaria. Fundamentos y planes.", "start": 399, "end": 507 }, 
 						{ "title": "7. Previsiones de tráfico.", "start": 497, "end": 622 }, 
 						{ "title": "8. Estudio de capacidad. Ordenación de terminales.", "start": 612 } 
 					] 
 				}, 
 				{ file: 'MEA2T19_DESPLEGABLE.html', title: 'Obras portuarias (II)', color: 'slate', icon: 'fa-hard-hat', videoId: '1yFk8qzQKyalZS6EGsncySfbqGuz9vd08',
 					chapters: [ 
 						{ "title": "1. Obras de abrigo y portuarias y definición y caracterización de la situación y factores de proyecto.", "start": 0, "end": 202 }, 
 						{ "title": "2. Estados límite últimos. Período de retorno.", "start": 192, "end": 266 }, 
 						{ "title": "3. Bases de datos. Clima marítimo, caracterización estadística de oleaje, parámetros.", "start": 256, "end": 583 }, 
 						{ "title": "4. Análisis estadístico del oleaje en aguas profundas y poco profundas régimen estremales y régimen medio.", "start": 573 } 
 					] 
 				}, 
 				{ file: 'MEA2T20_DESPLEGABLE.html', title: 'Obras portuarias (I)', color: 'zinc', icon: 'fa-ship', videoId: '1yFk8qzQKyalZS6EGsncySfbqGuz9vd08',
 					chapters: [ 
 						{ "title": "1. Obras de abrigo y portuarias y diseños y dimensionamiento. Diseño en planta.", "start": 0, "end": 185 }, 
 						{ "title": "2. Obras exteriores: Diques verticales, diques en talud, diques rebasables.", "start": 175, "end": 370 }, 
 						{ "title": "3. Obras interiores: muelles, dársenas, amarres, fondeo.", "start": 360, "end": 535 }, 
 						{ "title": "4. Superficies portuarias.", "start": 525, "end": 680 }, 
 						{ "title": "5. Profundidades accesorias, maniobrabilidad de buques.", "start": 670 } 
 					] 
 				} 
 			]; 
 			 
 			const colorPalette={blue:{normal:"bg-blue-100 text-blue-800",icon:"text-blue-500"},cyan:{normal:"bg-cyan-100 text-cyan-800",icon:"text-cyan-500"},sky:{normal:"bg-sky-100 text-sky-800",icon:"text-sky-500"},indigo:{normal:"bg-indigo-100 text-indigo-800",icon:"text-indigo-500"},green:{normal:"bg-green-100 text-green-800",icon:"text-green-500"},emerald:{normal:"bg-emerald-100 text-emerald-800",icon:"text-emerald-500"},teal:{normal:"bg-teal-100 text-teal-800",icon:"text-teal-500"},lime:{normal:"bg-lime-100 text-lime-800",icon:"text-lime-500"},yellow:{normal:"bg-yellow-100 text-yellow-800",icon:"text-yellow-500"},amber:{normal:"bg-amber-100 text-amber-800",icon:"text-amber-500"},orange:{normal:"bg-orange-100 text-orange-800",icon:"text-orange-500"},red:{normal:"bg-red-100 text-red-800",icon:"text-red-500"},rose:{normal:"bg-rose-100 text-rose-800",icon:"text-rose-500"},pink:{normal:"bg-pink-100 text-pink-800",icon:"text-pink-500"},fuchsia:{normal:"bg-fuchsia-100 text-fuchsia-800",icon:"text-fuchsia-500"},purple:{normal:"bg-purple-100 text-purple-800",icon:"text-purple-500"},violet:{normal:"bg-violet-100 text-violet-800",icon:"text-violet-500"},gray:{normal:"bg-gray-100 text-gray-800",icon:"text-gray-500"},slate:{normal:"bg-slate-100 text-slate-800",icon:"text-slate-500"},zinc:{normal:"bg-zinc-100 text-zinc-800",icon:"text-zinc-500"}}; 
 			const gridContainer=document.getElementById("topics-grid"),mainMenuView=document.getElementById("main-menu-view"),mapViewerVIew=document.getElementById("map-viewer-view"),backButton=document.getElementById("back-button"),topControlBar=document.getElementById("top-control-bar"),chaptersMenuContainer=document.getElementById("chapters-menu-container"),chaptersButton=document.getElementById("chapters-button"),chaptersDropdown=document.getElementById("chapters-dropdown"),topicAudio=document.getElementById("topic-audio"),playPauseButton=document.getElementById("play-pause-button"),playPauseIcon=document.getElementById("play-pause-icon"),rewindButton=document.getElementById("rewind-button"),forwardButton=document.getElementById("forward-button"),timelineSlider=document.getElementById("timeline-slider"),currentTimeEl=document.getElementById("current-time"),totalDurationEl=document.getElementById("total-duration"),speedButton=document.getElementById("speed-button"),loopButton=document.getElementById("loop-button"),editorPanel=document.getElementById("editor-panel"),editorList=document.getElementById("editor-list"),editModeToggle=document.getElementById("edit-mode-toggle"),saveDataButton=document.getElementById("save-data-button"),saveIcon=document.getElementById("save-icon"),saveText=document.getElementById("save-text"),saveNotification=document.getElementById("save-notification"),addChapterButton = document.getElementById("add-chapter-button"),passwordModalOverlay=document.getElementById("password-modal-overlay"),passwordInput=document.getElementById("password-input"),confirmEditButton=document.getElementById("confirm-edit-button"),cancelEditButton=document.getElementById("cancel-edit-button"),passwordError=document.getElementById("password-error"),newChapterTitleInput=document.getElementById("new-chapter-title-input"),restoreDefaultsButton = document.getElementById("restore-defaults-button"); 
 			const pdfViewerContainer = document.getElementById('pdf-viewer-container'), pdfCanvas = document.getElementById('pdf-canvas'), pageNumEl = document.getElementById('page-num'), pageCountEl = document.getElementById('page-count'), prevPageBtn = document.getElementById('prev-page'), nextPageBtn = document.getElementById('next-page'), pdfLoadingOverlay = document.getElementById('pdf-loading-overlay'), loadingText = document.getElementById('loading-text'), togglePdfButton = document.getElementById('toggle-pdf-button'), contentFrame = document.getElementById('content-frame');
            const toggleVideoButton = document.getElementById('toggle-video-button'), changeSessionButton = document.getElementById('change-session-button'), sessionModalOverlay = document.getElementById('session-modal-overlay'), sessionIdInput = document.getElementById('session-id-input'), startSessionButton = document.getElementById('start-session-button');
            const toggleOralPdfButton = document.getElementById('toggle-oral-pdf-button'), oralPdfViewerContainer = document.getElementById('oral-pdf-viewer-container');

 			topics.forEach((e,t)=>{ 
 				const o=document.createElement("button"),n=colorPalette[e.color]; 
 				o.className="topic-button",o.dataset.index=t,o.innerHTML=`<span class="topic-number ${n.normal}">${t+1}</span><i class="fas ${e.icon} topic-icon ${n.icon}"></i><span class="topic-title">${e.title}</span>`,gridContainer.appendChild(o) 
 			}); 

 			function updateChapters(chapters) { 
 				const chaptersToShow = chapters || [];
 				chaptersDropdown.innerHTML = ''; 
 				if (chaptersToShow.length > 0) { 
 					chaptersToShow.forEach(chapter => { 
 						const chapterButton = document.createElement('button'); 
 						chapterButton.className = 'chapter-button w-full text-left p-2 rounded hover:bg-gray-100 text-sm'; 
 						chapterButton.textContent = chapter.title; 
 						chapterButton.dataset.start = chapter.start; 
 						if(chapter.end !== undefined) { 
 							chapterButton.dataset.end = chapter.end; 
 						} 
 						chaptersDropdown.appendChild(chapterButton); 
 					}); 
 					chaptersMenuContainer.classList.remove('hidden'); 
 				} else { 
 					chaptersMenuContainer.classList.add('hidden'); 
 				} 
 			} 

 			function updateEditor(chapters){ 
 				const chaptersToEdit = chapters || [];
 				editedChapters=JSON.parse(JSON.stringify(chaptersToEdit)); 
 				renderEditorList(); 
 			} 
 			 
 			function renderEditorList() { 
 				editorList.innerHTML = ""; 
 				if(editedChapters.length > 0) { 
 					editedChapters.forEach((chapter, index) => { 
 						const item = document.createElement("div"); 
 						item.className = "edit-chapter-item p-2 border-b"; 
 						item.innerHTML = ` 
 							<div class="flex items-center gap-2"> 
 								<input type="text" value="${chapter.title.replace(/"/g, '&quot;')}" class="w-full font-semibold text-sm bg-gray-100 p-1 rounded border" data-index="${index}"> 
 								<button data-index="${index}" class="delete-chapter-button text-red-500 hover:text-red-700 p-1"><i class="fas fa-trash-alt"></i></button> 
 							</div> 
 							<div class="flex items-center justify-between mt-1 text-xs"> 
 								<div> 
 									<button data-index="${index}" data-type="start" class="mark-button bg-sky-500 text-white px-2 py-1 rounded-md hover:bg-sky-600">Inicio</button> 
 									<span class="ml-2 font-mono" id="start-time-${index}">${chapter.start ? formatTime(chapter.start) : "--:--"}</span> 
 								</div> 
 								<div> 
 									<button data-index="${index}" data-type="end" class="mark-button bg-pink-500 text-white px-2 py-1 rounded-md hover:bg-pink-600">Fin</button> 
 									<span class="ml-2 font-mono" id="end-time-${index}">${chapter.end ? formatTime(chapter.end) : "--:--"}</span> 
 								</div> 
 							</div>`; 
 						editorList.appendChild(item); 
 					}); 
 				} else { 
 					editorList.innerHTML='<p class="text-gray-500 text-sm">Este tema no tiene capítulos. Añade uno para empezar.</p>'; 
 				} 
 			} 

            async function renderPage(num, pdfInstance, canvas, pageNumEl, prevBtn, nextBtn) {
                if (!pdfInstance) return;
                const page = await pdfInstance.getPage(num);
                const viewport = page.getViewport({ scale: 1.5 });
                const canvasContext = canvas.getContext('2d');
                canvas.height = viewport.height;
                canvas.width = viewport.width;
                
                await page.render({ canvasContext, viewport }).promise;
                
                pageNumEl.textContent = num;
                prevBtn.disabled = num <= 1;
                nextBtn.disabled = num >= pdfInstance.numPages;
            }

            async function loadPdfAndFind(url, searchText, canvas, pageNumEl, pageCountEl, prevBtn, nextBtn, loadingOverlay, loadingTextEl) {
                loadingOverlay.style.display = 'flex';
                loadingTextEl.textContent = 'Cargando PDF...';
                let pdfInstance = null;

                try {
                    const loadingTask = pdfjsLib.getDocument(url);
                    pdfInstance = await loadingTask.promise;
                    pageCountEl.textContent = pdfInstance.numPages;
                    
                    loadingTextEl.textContent = `Buscando "${searchText}"...`;
                    let foundPage = 1;
                    for (let i = 1; i <= pdfInstance.numPages; i++) {
                        const page = await pdfInstance.getPage(i);
                        const textContent = await page.getTextContent();
                        const pageText = textContent.items.map(item => item.str).join('');
                        if (pageText.includes(searchText)) {
                            foundPage = i;
                            break;
                        }
                    }
                    if (canvas.id === 'pdf-canvas') {
                        pdfDoc = pdfInstance;
                        currentPageNum = foundPage;
                        await renderPage(currentPageNum, pdfDoc, pdfCanvas, pageNumEl, prevPageBtn, nextPageBtn);
                    } else {
                        oralPdfDoc = pdfInstance;
                        oralCurrentPageNum = foundPage;
                        await renderPage(oralCurrentPageNum, oralPdfDoc, canvas, pageNumEl, prevBtn, nextBtn);
                    }
                } catch (error) {
                    console.error('Error loading or searching PDF:', error);
                    alert('No se pudo cargar el PDF. Revisa la URL y asegúrate de que sea un enlace directo (raw) al archivo.');
                } finally {
                    loadingOverlay.style.display = 'none';
                }
            }
 
 			function showMapView(button){ 
 				playPauseButton.disabled = false;
 				playPauseIcon.className = "fas fa-play";
 				const topicIndex = button.dataset.index;
 				const baseTopic = topics[topicIndex];
 				const topicId = baseTopic.file.replace(/_desplegable\.html$/i, '');
 				
 				const chaptersToLoad = userCustomChapters[topicId] || (baseTopic.chapters ? JSON.parse(JSON.stringify(baseTopic.chapters)) : []);

 				currentTopic = { ...baseTopic, chapters: chaptersToLoad };
 				
 				mainMenuView.classList.add("hidden"); 
 				mapViewerVIew.classList.remove("hidden"); 
                
                contentFrame.src = `https://cheradra312.github.io/COSTAS_1-20/${currentTopic.file}`;
 				topicAudio.src = `audios/${currentTopic.file.replace(/_desplegable\.html$/i, ".mp3")}`;
 				
 				updateChapters(chaptersToLoad); 
 				updateEditor(chaptersToLoad); 
 				 
 				topControlBar.style.display="flex"; 
 				setTimeout(()=>topControlBar.style.opacity=1,10) 
 			} 

 			function showMainMenu(){ 
 				mapViewerVIew.classList.add("hidden");
                mainMenuView.classList.remove("hidden");
                topicAudio.pause();
                pdfDoc = null;
                oralPdfDoc = null;
                contentFrame.src = "";
                pdfViewerContainer.classList.add('hidden');
                oralPdfViewerContainer.classList.add('hidden');
                contentFrame.classList.remove('hidden');
                topControlBar.style.opacity=0;
                setTimeout(()=>topControlBar.style.display="none",300); 
 			} 
 			gridContainer.addEventListener("click",(e=>e.target.closest(".topic-button")&&showMapView(e.target.closest(".topic-button")))),backButton.addEventListener("click",showMainMenu); 
 			 
 			const formatTime=e=>isNaN(e)?"00:00":`${String(Math.floor(e/60)).padStart(2,"0")}:${String(Math.floor(e%60)).padStart(2,"0")}`; 
 			topicAudio.addEventListener("loadedmetadata",()=>{totalDurationEl.textContent=formatTime(topicAudio.duration),timelineSlider.max=topicAudio.duration}),topicAudio.addEventListener("error",()=>{playPauseButton.disabled=!0,playPauseIcon.className="fas fa-times",totalDurationEl.textContent="Error"}),playPauseButton.addEventListener("click",()=>{currentChapterEndTime=null,currentChapterStartTime=null,topicAudio.paused?topicAudio.play():topicAudio.pause()}),topicAudio.addEventListener("play",()=>playPauseIcon.classList.replace("fa-play","fa-pause")),topicAudio.addEventListener("pause",()=>playPauseIcon.classList.replace("fa-pause","fa-play")),topicAudio.addEventListener("ended",()=>{topicAudio.loop&&null===currentChapterStartTime||topicAudio.loop&&null!==currentChapterStartTime||playPauseIcon.classList.replace("fa-pause","fa-play")}),topicAudio.addEventListener("timeupdate",()=>{ 
 				if(timelineSlider.value=topicAudio.currentTime,currentTimeEl.textContent=formatTime(topicAudio.currentTime),currentChapterEndTime&&topicAudio.currentTime>=currentChapterEndTime) 
 					if(topicAudio.loop){topicAudio.currentTime=currentChapterStartTime,topicAudio.play(); 
 				} else{ 
 					topicAudio.pause(),currentChapterEndTime=null,currentChapterStartTime=null; 
 					const e=document.querySelector(".chapter-button.playing"); 
 					e&&e.classList.remove("playing") 
 				} 
 			}),timelineSlider.addEventListener("input",()=>{currentChapterEndTime=null,currentChapterStartTime=null,topicAudio.currentTime=timelineSlider.value}),chaptersButton.addEventListener("click",e=>{e.stopPropagation(),chaptersDropdown.classList.toggle("hidden")}),chaptersDropdown.addEventListener("click",e=>{ 
 				if("BUTTON"===e.target.tagName){ 
 					const t=document.querySelector(".chapter-button.playing"); 
 					t&&t.classList.remove("playing"),e.target.classList.add("playing"),currentChapterStartTime=parseFloat(e.target.dataset.start),currentChapterEndTime=e.target.dataset.end?parseFloat(e.target.dataset.end):null,topicAudio.currentTime=currentChapterStartTime,topicAudio.play(),chaptersDropdown.classList.add("hidden") 
 				} 
 			}); 
 			
 			rewindButton.addEventListener('click', () => {
 				topicAudio.currentTime = Math.max(0, topicAudio.currentTime - 3);
 			});

 			forwardButton.addEventListener('click', () => {
 				topicAudio.currentTime = Math.min(topicAudio.duration, topicAudio.currentTime + 3);
 			});

 			const speeds=[1,1.25,1.5,2]; 
 			let currentSpeedIndex=0; 
 			speedButton.addEventListener("click",()=>{currentSpeedIndex=(currentSpeedIndex+1)%speeds.length;const e=speeds[currentSpeedIndex];topicAudio.playbackRate=e,speedButton.textContent=`${e}x`});
 			loopButton.addEventListener("click",()=>{topicAudio.loop=!topicAudio.loop,loopButton.classList.toggle("active")});
 			document.addEventListener("click",e=>{chaptersMenuContainer.contains(e.target)||chaptersDropdown.classList.add("hidden")}); 
 			 
 			editModeToggle.addEventListener("change",()=>{ 
 				if (editModeToggle.checked) { 
 					passwordModalOverlay.classList.remove('hidden'); 
 				} else { 
 					let isEditMode = false; 
 					editorPanel.style.opacity = 0; 
 					setTimeout(() => editorPanel.style.display = 'none', 300); 
 				} 
 			}); 

 			function enterEditMode() { 
 				let isEditMode = true; 
 				editorPanel.style.display="block"; 
 				setTimeout(()=>editorPanel.style.opacity=1,10); 
 				passwordModalOverlay.classList.add('hidden'); 
 				passwordInput.value = ''; 
 				passwordError.classList.add('hidden'); 
 			} 

 			function closePasswordModal() { 
 				passwordModalOverlay.classList.add('hidden'); 
 				editModeToggle.checked = false; 
 				passwordInput.value = ''; 
 				passwordError.classList.add('hidden'); 
 			} 
 			 
 			confirmEditButton.addEventListener('click', () => { 
 				if (passwordInput.value === "1234") { 
 					enterEditMode(); 
 				} else { 
 					passwordError.classList.remove('hidden'); 
 				} 
 			}); 
 			cancelEditButton.addEventListener('click', closePasswordModal); 
 			passwordModalOverlay.addEventListener('click', (e) => { 
 				if (e.target === passwordModalOverlay) { 
 					closePasswordModal(); 
 				} 
 			}); 

 			editorList.addEventListener("click",e=>{ 
 				const t=e.target.closest(".mark-button, .delete-chapter-button"); 
 				if(t){ 
 					const o=t.dataset.index; 
 					if (t.classList.contains('mark-button')) { 
 						const n=t.dataset.type, a=Math.round(100*topicAudio.currentTime)/100; 
 						editedChapters[o][n]=a,document.getElementById(`${n}-time-${o}`).textContent=formatTime(a); 
 					} else if (t.classList.contains('delete-chapter-button')) { 
 						editedChapters.splice(o, 1); 
 						renderEditorList(); 
 					} 
 				} 
 			}); 

 			editorList.addEventListener('input', e => { 
 				if (e.target.tagName === 'INPUT' && e.target.type === 'text') { 
 					const index = e.target.dataset.index; 
 					editedChapters[index].title = e.target.value; 
 				} 
 			}); 
 			 
 			addChapterButton.addEventListener('click', () => { 
 				const newTitle = newChapterTitleInput.value.trim(); 
 				if (newTitle) { 
 					editedChapters.push({ title: newTitle, start: 0, end: 0 }); 
 					renderEditorList(); 
 					newChapterTitleInput.value = ''; 
 				} 
 			}); 

 			saveDataButton.addEventListener("click",async()=>{ 
 				const topicId = currentTopic.file.replace(/_desplegable\.html$/i, '');
                userCustomChapters[topicId] = editedChapters;
 				const docRef = doc(db, `artifacts/${appId}/public/data/sessions`, userId);
 				const dataToSave = { ...userCustomChapters }; 

 				saveIcon.className = "fas fa-spinner fa-spin"; 
 				saveText.textContent = "Guardando..."; 

 				try { 
 					await setDoc(docRef, dataToSave);
 					currentTopic.chapters = JSON.parse(JSON.stringify(editedChapters));
 					updateChapters(currentTopic.chapters);

 					saveNotification.textContent = "¡Guardado!";
 					saveNotification.style.opacity=1; 
 					setTimeout(()=>{ saveNotification.style.opacity=0 }, 2000); 
 				} catch (error) { 
 					console.error("Error al guardar en Firestore: ", error); 
 				} finally { 
 					saveIcon.className = "fas fa-cloud-upload-alt"; 
 					saveText.textContent = "Guardar en la Nube"; 
 				} 
 			}); 

 			restoreDefaultsButton.addEventListener('click', async () => {
 				if (!currentTopic) return;

 				const topicId = currentTopic.file.replace(/_desplegable\.html$/i, '');
 				const originalTopic = topics.find(t => t.file === currentTopic.file);
 				if (!originalTopic) return;

 				const defaultChapters = originalTopic.chapters ? JSON.parse(JSON.stringify(originalTopic.chapters)) : [];
 				
 				updateEditor(defaultChapters);
 				updateChapters(defaultChapters);

                userCustomChapters[topicId] = defaultChapters;
 				const docRef = doc(db, `artifacts/${appId}/public/data/sessions`, userId);
 				const dataToSave = { ...userCustomChapters };

 				const originalButtonText = restoreDefaultsButton.innerHTML;
 				restoreDefaultsButton.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Restaurando...`;
 				restoreDefaultsButton.disabled = true;

 				try {
 					await setDoc(docRef, dataToSave, { merge: true });
 					currentTopic.chapters = defaultChapters;
 					
 					saveNotification.textContent = "¡Valores por defecto restaurados!";
 					saveNotification.style.opacity = 1;
 					setTimeout(() => { saveNotification.style.opacity = 0 }, 2000);

 				} catch (error) {
 					console.error("Error restoring defaults to Firestore: ", error);
 				} finally {
 					restoreDefaultsButton.innerHTML = originalButtonText;
 					restoreDefaultsButton.disabled = false;
 				}
 			});

            prevPageBtn.addEventListener('click', () => {
                if (currentPageNum <= 1) return;
                currentPageNum--;
                renderPage(currentPageNum, pdfDoc, pdfCanvas, pageNumEl, prevPageBtn, nextPageBtn);
            });

            nextPageBtn.addEventListener('click', () => {
                if (!pdfDoc || currentPageNum >= pdfDoc.numPages) return;
                currentPageNum++;
                renderPage(currentPageNum, pdfDoc, pdfCanvas, pageNumEl, prevPageBtn, nextPageBtn);
            });
            
            const oralPrevPageBtn = document.getElementById('oral-prev-page');
            const oralNextPageBtn = document.getElementById('oral-next-page');

            oralPrevPageBtn.addEventListener('click', () => {
                if (oralCurrentPageNum <= 1) return;
                oralCurrentPageNum--;
                renderPage(oralCurrentPageNum, oralPdfDoc, document.getElementById('oral-pdf-canvas'), document.getElementById('oral-page-num'), oralPrevPageBtn, oralNextPageBtn);
            });

            oralNextPageBtn.addEventListener('click', () => {
                if (!oralPdfDoc || oralCurrentPageNum >= oralPdfDoc.numPages) return;
                oralCurrentPageNum++;
                renderPage(oralCurrentPageNum, oralPdfDoc, document.getElementById('oral-pdf-canvas'), document.getElementById('oral-page-num'), oralPrevPageBtn, oralNextPageBtn);
            });

            togglePdfButton.addEventListener('click', () => {
                oralPdfViewerContainer.classList.add('hidden');
                const isPdfVisible = !pdfViewerContainer.classList.contains('hidden');
                if (isPdfVisible) {
                    pdfViewerContainer.classList.add('hidden');
                    contentFrame.classList.remove('hidden');
                } else {
                    pdfViewerContainer.classList.remove('hidden');
                    contentFrame.classList.add('hidden');
                     const pdfUrl = 'https://raw.githubusercontent.com/cheradra312/COSTAS_1-20/main/Facilitador%20CICCPE%20Temario%20Condensado%20MEA2%20(versi%C3%B3n%202025-01).pdf';
                     const topicId = currentTopic.file.replace(/_desplegable\.html$/i, '');
                     if (!pdfDoc) { 
                        loadPdfAndFind(pdfUrl, topicId, pdfCanvas, pageNumEl, pageCountEl, prevPageBtn, nextPageBtn, pdfLoadingOverlay, loadingText);
                     }
                }
            });

            toggleOralPdfButton.addEventListener('click', () => {
                pdfViewerContainer.classList.add('hidden');
                const isOralPdfVisible = !oralPdfViewerContainer.classList.contains('hidden');

                if(isOralPdfVisible) {
                    oralPdfViewerContainer.classList.add('hidden');
                    contentFrame.classList.remove('hidden');
                } else {
                    oralPdfViewerContainer.classList.remove('hidden');
                    contentFrame.classList.add('hidden');
                    const oralPdfUrl = 'https://raw.githubusercontent.com/cheradra312/COSTAS_1-20/main/Facilitador%20CICCPE%20Preguntas%20oral%20MEA2%20(versi%C3%B3n%202025-01).pdf';
                    const topicId = currentTopic.file.replace(/_desplegable\.html$/i, '');
                     if (!oralPdfDoc) { 
                        loadPdfAndFind(oralPdfUrl, topicId, document.getElementById('oral-pdf-canvas'), document.getElementById('oral-page-num'), document.getElementById('oral-page-count'), oralPrevPageBtn, oralNextPageBtn, document.getElementById('oral-pdf-loading-overlay'), document.getElementById('oral-loading-text'));
                     }
                }
            });

            toggleVideoButton.addEventListener('click', () => {
                if (!currentTopic || !currentTopic.videoId || currentTopic.videoId === 'ID_DE_TU_VIDEO_AQUI') {
                    alert('Este tema no tiene un vídeo asociado.');
                    return;
                }
                
                let videoUrl;
                if (currentTopic.videoId.startsWith('http')) {
                    videoUrl = currentTopic.videoId;
                } else {
                    videoUrl = `https://drive.google.com/file/d/${currentTopic.videoId}/view`; // Changed to /view
                }
                window.open(videoUrl, '_blank');
                topicAudio.pause();
            });

            startSessionButton.addEventListener('click', () => {
                const sessionId = sessionIdInput.value.trim();
                if (sessionId) {
                    localStorage.setItem('sessionId', sessionId);
                    handleSession();
                }
            });

            changeSessionButton.addEventListener('click', () => {
                localStorage.removeItem('sessionId');
                window.location.reload();
            });
 		}); 
 	</script> 
 </body> 
 </html>
