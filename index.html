<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visor de Mapas Conceptuales con Editor</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .topic-button { background-color: #ffffff; border: 1px solid #d1d5db; color: #374151; padding: 1rem; border-radius: 0.75rem; text-align: left; transition: all 0.2s ease-in-out; cursor: pointer; display: flex; align-items: center; gap: 0.75rem; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); }
        .topic-button:hover { transform: translateY(-3px); box-shadow: 0 6px 16px rgba(0, 0, 0, 0.08); }
        .topic-number { border-radius: 9999px; font-weight: 700; font-size: 1.125rem; width: 2.75rem; height: 2.75rem; display: flex; align-items: center; justify-content: center; flex-shrink: 0; transition: all 0.2s ease-in-out; }
        .topic-title { font-weight: 600; flex-grow: 1; }
        .topic-icon { font-size: 1.25rem; width: 2rem; text-align: center; transition: color 0.2s ease-in-out; }
        #top-control-bar, #editor-panel { display: none; opacity: 0; transition: opacity 0.3s ease-in-out; }
        input[type="range"]::-webkit-slider-runnable-track { background: #e5e7eb; height: 0.25rem; border-radius: 1rem; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; margin-top: -6px; background-color: #3b82f6; height: 1rem; width: 1rem; border-radius: 50%; }
        input[type="range"] { -webkit-appearance: none; appearance: none; background: transparent; cursor: pointer; }
        #play-pause-button:disabled { background-color: #9ca3af; cursor: not-allowed; transform: none; }
        .chapter-button.playing, .edit-chapter-item.active { background-color: #dbeafe; font-weight: 700; color: #1e3a8a; }
        #loop-button.active { color: #ffffff; background-color: #3b82f6; }
        #edit-mode-toggle { -webkit-appearance: none; appearance: none; height: 1.25rem; width: 2.25rem; }
        #edit-mode-toggle:checked::after { transform: translateX(1rem); }
        #edit-mode-toggle::after { content: ''; display: inline-block; width: 1rem; height: 1rem; border-radius: 50%; background: white; transition: transform 0.2s ease-in-out; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
        .modal-overlay { transition: opacity 0.3s ease-in-out; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <!-- VISTA DEL MENÚ PRINCIPAL -->
        <div id="main-menu-view">
            <header class="text-center mb-8"><h1 class="text-3xl md:text-4xl font-extrabold text-gray-800">Visor de Mapas Conceptuales</h1><p class="text-lg text-gray-500 mt-2">Selecciona un tema para comenzar</p></header>
            <div id="topics-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4"></div>
        </div>

        <!-- VISTA DEL VISOR DE MAPAS -->
        <div id="map-viewer-view" class="hidden">
            <div id="top-control-bar" class="flex justify-between items-center gap-4 mb-4">
                <button id="back-button" class="bg-white text-gray-700 font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-gray-100 flex items-center gap-2">
                    <i class="fas fa-arrow-left"></i><span class="hidden sm:inline">Volver</span>
                </button>
                <div class="flex items-center gap-4">
                     <div class="flex items-center gap-2 bg-white px-3 py-1.5 rounded-lg shadow-md">
                        <label for="edit-mode-toggle" class="text-sm font-medium text-gray-700">Editar</label>
                        <input type="checkbox" id="edit-mode-toggle" class="h-5 w-9 -checked:after:translate-x-full relative inline-flex cursor-pointer items-center rounded-full bg-gray-300 transition checked:bg-blue-500">
                    </div>
                    <div id="audio-player" class="bg-white p-2 rounded-lg shadow-md flex items-center gap-3 relative">
                        <div id="chapters-menu-container" class="relative">
                            <button id="chapters-button" class="text-gray-600 hover:bg-gray-200 rounded-full w-10 h-10 flex-shrink-0 flex items-center justify-center transition"><i class="fas fa-list-ul"></i></button>
                            <div id="chapters-dropdown" class="absolute top-full mt-2 right-0 md:left-0 bg-white shadow-lg rounded-lg p-2 w-80 max-h-72 overflow-y-auto hidden z-10"></div>
                        </div>
                        <button id="play-pause-button" class="text-white bg-blue-500 hover:bg-blue-600 rounded-full w-10 h-10 flex-shrink-0 flex items-center justify-center transition-transform transform hover:scale-110"><i id="play-pause-icon" class="fas fa-play"></i></button>
                        <div class="flex items-center gap-2 text-xs text-gray-500"><span id="current-time">00:00</span><input type="range" id="timeline-slider" class="w-24 md:w-32" value="0" step="1"><span id="total-duration">00:00</span></div>
                        <div class="flex items-center gap-3"><button id="loop-button" class="text-gray-500 hover:bg-gray-200 rounded-full w-9 h-9 flex-shrink-0 transition-colors"><i class="fas fa-retweet"></i></button><button id="speed-button" class="text-xs font-bold text-blue-500 bg-blue-100 hover:bg-blue-200 rounded-full w-9 h-9 flex-shrink-0">1x</button><div class="hidden md:flex items-center gap-2"><i id="volume-icon" class="fas fa-volume-high text-gray-500 cursor-pointer"></i><input type="range" id="volume-slider" class="w-16" min="0" max="1" step="0.05" value="1"></div></div>
                    </div>
                </div>
            </div>

            <div class="flex flex-col lg:flex-row gap-4">
                <!-- PANEL DE EDICIÓN -->
                <div id="editor-panel" class="w-full lg:w-1/3 bg-white p-4 rounded-lg shadow-lg border border-gray-200 hidden">
                    <h3 class="font-bold text-lg mb-2 border-b pb-2">Editor de Capítulos</h3>
                    <div id="editor-list" class="space-y-2 max-h-[60vh] overflow-y-auto pr-2"></div>
                     <div class="mt-4 flex gap-2">
                        <input type="text" id="new-chapter-title-input" placeholder="Título del nuevo epígrafe" class="flex-grow p-2 border rounded-md text-sm">
                        <button id="add-chapter-button" class="bg-indigo-500 text-white font-bold p-2 rounded-md hover:bg-indigo-600">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    <button id="save-data-button" class="mt-2 w-full bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 flex items-center justify-center gap-2">
                        <i id="save-icon" class="fas fa-cloud-upload-alt"></i><span id="save-text">Guardar en la Nube</span>
                    </button>
                    <p id="save-notification" class="text-center text-green-700 font-semibold mt-2 opacity-0 transition-opacity">¡Guardado!</p>
                </div>
                <!-- Iframe -->
                <div id="iframe-container" class="flex-1 transition-all duration-300">
                     <iframe id="content-frame" class="w-full border-0 rounded-xl" style="min-height: 80vh;" src=""></iframe>
                </div>
            </div>
        </div>
        
        <!-- MODAL DE CONTRASEÑA -->
        <div id="password-modal-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 modal-overlay">
            <div class="bg-white p-6 rounded-lg shadow-2xl w-full max-w-sm">
                <h2 class="text-lg font-bold mb-4">Modo Edición Protegido</h2>
                <p class="text-sm text-gray-600 mb-2">Introduce la contraseña para continuar.</p>
                <input type="password" id="password-input" class="w-full border border-gray-300 p-2 rounded-md mb-2">
                <p id="password-error" class="text-red-500 text-xs hidden mb-4">Contraseña incorrecta.</p>
                <div class="flex justify-end gap-2">
                    <button id="cancel-edit-button" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-300">Cancelar</button>
                    <button id="confirm-edit-button" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600">Aceptar</button>
                </div>
            </div>
        </div>
        
        <audio id="topic-audio" src=""></audio>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        
        // --- Declaración de variables globales y constantes ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        let db, auth, userId, currentTopic;
        let currentChapterEndTime=null, currentChapterStartTime=null, editedChapters=[];

        // Declaración de Elementos del DOM
        const gridContainer=document.getElementById("topics-grid"),mainMenuView=document.getElementById("main-menu-view"),mapViewerVIew=document.getElementById("map-viewer-view"),backButton=document.getElementById("back-button"),iframe=document.getElementById("content-frame"),topControlBar=document.getElementById("top-control-bar"),chaptersMenuContainer=document.getElementById("chapters-menu-container"),chaptersButton=document.getElementById("chapters-button"),chaptersDropdown=document.getElementById("chapters-dropdown"),topicAudio=document.getElementById("topic-audio"),playPauseButton=document.getElementById("play-pause-button"),playPauseIcon=document.getElementById("play-pause-icon"),timelineSlider=document.getElementById("timeline-slider"),currentTimeEl=document.getElementById("current-time"),totalDurationEl=document.getElementById("total-duration"),speedButton=document.getElementById("speed-button"),loopButton=document.getElementById("loop-button"),volumeSlider=document.getElementById("volume-slider"),volumeIcon=document.getElementById("volume-icon"),editorPanel=document.getElementById("editor-panel"),editorList=document.getElementById("editor-list"),editModeToggle=document.getElementById("edit-mode-toggle"),saveDataButton=document.getElementById("save-data-button"),saveIcon=document.getElementById("save-icon"),saveText=document.getElementById("save-text"),saveNotification=document.getElementById("save-notification"),iframeContainer=document.getElementById("iframe-container"),addChapterButton = document.getElementById("add-chapter-button"),passwordModalOverlay=document.getElementById("password-modal-overlay"),passwordInput=document.getElementById("password-input"),confirmEditButton=document.getElementById("confirm-edit-button"),cancelEditButton=document.getElementById("cancel-edit-button"),passwordError=document.getElementById("password-error"),newChapterTitleInput=document.getElementById("new-chapter-title-input");
        
        const colorPalette={blue:{normal:"bg-blue-100 text-blue-800",icon:"text-blue-500"},cyan:{normal:"bg-cyan-100 text-cyan-800",icon:"text-cyan-500"},sky:{normal:"bg-sky-100 text-sky-800",icon:"text-sky-500"},indigo:{normal:"bg-indigo-100 text-indigo-800",icon:"text-indigo-500"},green:{normal:"bg-green-100 text-green-800",icon:"text-green-500"},emerald:{normal:"bg-emerald-100 text-emerald-800",icon:"text-emerald-500"},teal:{normal:"bg-teal-100 text-teal-800",icon:"text-teal-500"},lime:{normal:"bg-lime-100 text-lime-800",icon:"text-lime-500"},yellow:{normal:"bg-yellow-100 text-yellow-800",icon:"text-yellow-500"},amber:{normal:"bg-amber-100 text-amber-800",icon:"text-amber-500"},orange:{normal:"bg-orange-100 text-orange-800",icon:"text-orange-500"},red:{normal:"bg-red-100 text-red-800",icon:"text-red-500"},rose:{normal:"bg-rose-100 text-rose-800",icon:"text-rose-500"},pink:{normal:"bg-pink-100 text-pink-800",icon:"text-pink-500"},fuchsia:{normal:"bg-fuchsia-100 text-fuchsia-800",icon:"text-fuchsia-500"},purple:{normal:"bg-purple-100 text-purple-800",icon:"text-purple-500"},violet:{normal:"bg-violet-100 text-violet-800",icon:"text-violet-500"},gray:{normal:"bg-gray-100 text-gray-800",icon:"text-gray-500"},slate:{normal:"bg-slate-100 text-slate-800",icon:"text-slate-500"},zinc:{normal:"bg-zinc-100 text-zinc-800",icon:"text-zinc-500"}};
        let topics = []; // Se llenará desde Firebase

        // --- Lógica Principal ---
        async function main() {
            initializeFirebase();
            await authenticateUser();
            await loadTopicsFromFirebase();
            setupEventListeners();
        }

        function initializeFirebase() {
            let firebaseConfig;
            try {
                // CORRECCIÓN: Usar la configuración proporcionada directamente.
                firebaseConfig = {
                    apiKey: "AIzaSyCKXzSmQ9F1M4W59Vyalu3CWdKFsh7dOmE",
                    authDomain: "costas-304b9.firebaseapp.com",
                    projectId: "costas-304b9",
                    storageBucket: "costas-304b9.appspot.com",
                    messagingSenderId: "251850800414",
                    appId: "1:251850800414:web:435e20e5305881732e5d0f",
                    measurementId: "G-C2NTL72PZH"
                };
                if (typeof __firebase_config !== 'undefined' && __firebase_config) {
                     const envConfig = JSON.parse(__firebase_config);
                     if (envConfig.projectId) firebaseConfig = envConfig;
                }
            } catch (e) { console.error("Firebase config parsing error:", e); }
            
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        }

        async function authenticateUser() {
            try {
                if (!auth) { console.error("Firebase Auth no está inicializado."); return; }
                const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                if (token) await signInWithCustomToken(auth, token);
                else await signInAnonymously(auth);
                userId = auth.currentUser.uid;
            } catch (error) {
                console.error("Error de autenticación:", error);
                userId = `anon_${crypto.randomUUID()}`;
            }
        }

        async function loadTopicsFromFirebase() {
            const defaultTopics = [
                 { file: 'MEA2T1_Desplegable.html', title: 'La Legislación de Costas', color: 'blue', icon: 'fa-gavel' },
                { file: 'MEA2T2_DESPLEGABLE.html', title: 'Bienes de Dominio Público Marítimo-Terrestre', color: 'cyan', icon: 'fa-landmark' },
                { file: 'MEA2T3_DESPLEGABLE.html', title: 'Limitaciones a la propiedad', color: 'sky', icon: 'fa-ban' },
                { file: 'MEA2T4_DESPLEGABLE.html', title: 'Utilización del DPMT', color: 'indigo', icon: 'fa-swimmer' },
                { file: 'MEA2T5_DESPLEGABLE.html', title: 'Régimen Económico-Financiero', color: 'green', icon: 'fa-coins' },
                { file: 'MEA2T6_DESPLEGABLE.html', title: 'Competencias de la AGE según la ley 22/1988', color: 'emerald', icon: 'fa-building-columns' },
                { file: 'MEA2T7_DESPLEGABLE.html', title: 'Régimen Transitorio', color: 'teal', icon: 'fa-history' },
                { file: 'MEA2T8_DESPLEGABLE.html', title: 'Las autorizaciones en servidumbre de protección', color: 'lime', icon: 'fa-file-signature' },
                { file: 'MEA2T9_DESPLEGABLE.html', title: 'Biodiversidad y conservación de ecosistemas marinos y costeros', color: 'yellow', icon: 'fa-seedling' },
                { file: 'MEA2T10_DESPLEGABLE.html', title: 'La gestión integral del litoral', color: 'amber', icon: 'fa-tasks' },
                { file: 'MEA2T11_DESPLEGABLE.html', title: 'Las distintas teorías de ondas', color: 'orange', icon: 'fa-wave-square' },
                { file: 'MEA2T12_DESPLEGABLE.html', title: 'El transporte sólido litoral', color: 'red', icon: 'fa-arrows-left-right' },
                { file: 'MEA2T13_DESPLEGABLE.html', title: 'Los efectos del cambio climático sobre el litoral', color: 'rose', icon: 'fa-temperature-high' },
                { file: 'MEA2T14_DESPLEGABLE.html', title: 'Las estrategias marinas en España', color: 'pink', icon: 'fa-map' },
                { file: 'MEA2T15_DESPLEGABLE.html', title: 'La erosión en los distintos tipos de playas', color: 'fuchsia', icon: 'fa-mountain-sun' },
                { file: 'MEA2T16_DESPLEGABLE.html', title: 'Proyectos de playas artificiales', color: 'purple', icon: 'fa-umbrella-beach' },
                { file: 'MEA2T17_DESPLEGABLE.html', title: 'Las fuentes naturales de sedimentos', color: 'violet', icon: 'fa-stream' },
                { file: 'MEA2T18_DESPLEGABLE.html', title: 'El puerto', color: 'gray', icon: 'fa-anchor' },
                { file: 'MEA2T19_DESPLEGABLE.html', title: 'Obras portuarias (II)', color: 'slate', icon: 'fa-hard-hat' },
                { file: 'MEA2T20_DESPLEGABLE.html', title: 'Obras portuarias (I)', color: 'zinc', icon: 'fa-ship' }
            ];

            try {
                const topicsRef = collection(db, `artifacts/${appId}/users/${userId}/topics`);
                const querySnapshot = await getDocs(topicsRef);
                const firebaseTopics = {};
                querySnapshot.forEach(doc => {
                    firebaseTopics[doc.id] = doc.data();
                });
                topics = defaultTopics.map(defaultTopic => {
                    const topicId = defaultTopic.file.replace(/_desplegable\.html$/i, '');
                    return firebaseTopics[topicId] ? { ...defaultTopic, ...firebaseTopics[topicId] } : defaultTopic;
                });
            } catch(e) {
                console.error("Error cargando datos de Firebase. Usando datos por defecto.", e);
                topics = defaultTopics;
            } finally {
                renderTopicGrid();
            }
        }
        
        function renderTopicGrid() {
             gridContainer.innerHTML = '';
             topics.forEach((topic, index) => {
                const button = document.createElement("button");
                const colors = colorPalette[topic.color];
                button.className = "topic-button";
                button.dataset.index = index;
                button.innerHTML = `<span class="topic-number ${colors.normal}">${index + 1}</span><i class="fas ${topic.icon} topic-icon ${colors.icon}"></i><span class="topic-title">${topic.title}</span>`;
                gridContainer.appendChild(button);
            });
        }
        
        async function updateChapters(topic) {
            const topicId = topic.file.replace(/_desplegable\.html$/i, '');
            const docRef = doc(db, `artifacts/${appId}/users/${userId}/topics`, topicId);
            const docSnap = await getDoc(docRef);
            const chaptersToShow = docSnap.exists() ? docSnap.data().chapters : (topic.chapters || []);
            
            chaptersDropdown.innerHTML = '';
            if (chaptersToShow.length > 0) {
                chaptersToShow.forEach(chapter => {
                    const chapterButton = document.createElement('button');
                    chapterButton.className = 'chapter-button w-full text-left p-2 rounded hover:bg-gray-100 text-sm';
                    chapterButton.textContent = chapter.title;
                    chapterButton.dataset.start = chapter.start;
                    if(chapter.end !== undefined) chapterButton.dataset.end = chapter.end;
                    chaptersDropdown.appendChild(chapterButton);
                });
                chaptersMenuContainer.classList.remove('hidden');
            } else {
                chaptersMenuContainer.classList.add('hidden');
            }
        }
        
        async function updateEditor(topic){
            const topicId = topic.file.replace(/_desplegable\.html$/i, '');
            const docRef = doc(db, `artifacts/${appId}/users/${userId}/topics`, topicId);
            const docSnap = await getDoc(docRef);
            const chaptersToEdit = docSnap.exists() ? docSnap.data().chapters : (topic.chapters || []);
            editedChapters=JSON.parse(JSON.stringify(chaptersToEdit));
            renderEditorList();
        }
        
        function renderEditorList() {
            editorList.innerHTML = "";
            if(editedChapters.length > 0) {
                editedChapters.forEach((chapter, index) => {
                    const item = document.createElement("div");
                    item.className = "edit-chapter-item p-2 border-b";
                    item.innerHTML = `
                        <div class="flex items-center gap-2">
                            <input type="text" value="${chapter.title}" class="w-full font-semibold text-sm bg-gray-100 p-1 rounded border" data-index="${index}">
                            <button data-index="${index}" class="delete-chapter-button text-red-500 hover:text-red-700 p-1"><i class="fas fa-trash-alt"></i></button>
                        </div>
                        <div class="flex items-center justify-between mt-1 text-xs">
                            <div><button data-index="${index}" data-type="start" class="mark-button bg-sky-500 text-white px-2 py-1 rounded-md hover:bg-sky-600">Inicio</button><span class="ml-2 font-mono" id="start-time-${index}">${chapter.start ? formatTime(chapter.start) : "--:--"}</span></div>
                            <div><button data-index="${index}" data-type="end" class="mark-button bg-pink-500 text-white px-2 py-1 rounded-md hover:bg-pink-600">Fin</button><span class="ml-2 font-mono" id="end-time-${index}">${chapter.end ? formatTime(chapter.end) : "--:--"}</span></div>
                        </div>`;
                    editorList.appendChild(item);
                });
            } else {
                editorList.innerHTML='<p class="text-gray-500 text-sm">Este tema no tiene capítulos. Añade uno para empezar.</p>';
            }
        }

        async function showMapView(button){
            playPauseButton.disabled = !1, playPauseIcon.className = "fas fa-play";
            currentTopic = topics[button.dataset.index];
            mainMenuView.classList.add("hidden"), mapViewerVIew.classList.remove("hidden"), iframe.src = currentTopic.file, topicAudio.src = `audios/${currentTopic.file.replace(/_desplegable\.html$/i,".mp3")}`;
            await updateChapters(currentTopic);
            await updateEditor(currentTopic);
            topControlBar.style.display="flex", setTimeout(()=>topControlBar.style.opacity=1,10);
        }

        function showMainMenu(){ mapViewerVIew.classList.add("hidden"),mainMenuView.classList.remove("hidden"),topicAudio.pause(),iframe.src="",topControlBar.style.opacity=0,setTimeout(()=>topControlBar.style.display="none",300); }
        
        const formatTime=e=>isNaN(e)?"00:00":`${String(Math.floor(e/60)).padStart(2,"0")}:${String(Math.floor(e%60)).padStart(2,"0")}`;

        function setupEventListeners() {
            gridContainer.addEventListener("click",(e=>e.target.closest(".topic-button")&&showMapView(e.target.closest(".topic-button"))));
            backButton.addEventListener("click",showMainMenu);
            topicAudio.addEventListener("loadedmetadata",()=>{totalDurationEl.textContent=formatTime(topicAudio.duration),timelineSlider.max=topicAudio.duration});
            topicAudio.addEventListener("error",()=>{playPauseButton.disabled=!0,playPauseIcon.className="fas fa-times",totalDurationEl.textContent="Error"});
            playPauseButton.addEventListener("click",()=>{currentChapterEndTime=null,currentChapterStartTime=null,topicAudio.paused?topicAudio.play():topicAudio.pause()});
            topicAudio.addEventListener("play",()=>playPauseIcon.classList.replace("fa-play","fa-pause"));
            topicAudio.addEventListener("pause",()=>playPauseIcon.classList.replace("fa-pause","fa-play"));
            topicAudio.addEventListener("ended",()=>{ if(!topicAudio.loop) playPauseIcon.classList.replace("fa-pause","fa-play")});
            topicAudio.addEventListener("timeupdate",()=>{
                timelineSlider.value=topicAudio.currentTime;
                currentTimeEl.textContent=formatTime(topicAudio.currentTime);
                if(currentChapterEndTime&&topicAudio.currentTime>=currentChapterEndTime)
                    if(topicAudio.loop){ topicAudio.currentTime=currentChapterStartTime,topicAudio.play(); }
                    else{ topicAudio.pause(),currentChapterEndTime=null,currentChapterStartTime=null;const e=document.querySelector(".chapter-button.playing");e&&e.classList.remove("playing")}
            });
            timelineSlider.addEventListener("input",()=>{currentChapterEndTime=null,currentChapterStartTime=null,topicAudio.currentTime=timelineSlider.value});
            chaptersButton.addEventListener("click",e=>{e.stopPropagation(),chaptersDropdown.classList.toggle("hidden")});
            chaptersDropdown.addEventListener("click",e=>{
                if("BUTTON"===e.target.tagName){
                    const t=document.querySelector(".chapter-button.playing");
                    t&&t.classList.remove("playing"),e.target.classList.add("playing"),currentChapterStartTime=parseFloat(e.target.dataset.start),currentChapterEndTime=e.target.dataset.end?parseFloat(e.target.dataset.end):null,topicAudio.currentTime=currentChapterStartTime,topicAudio.play(),chaptersDropdown.classList.add("hidden")
                }
            });
            const speeds=[1,1.25,1.5,2];
            let currentSpeedIndex=0;
            speedButton.addEventListener("click",()=>{currentSpeedIndex=(currentSpeedIndex+1)%speeds.length;const e=speeds[currentSpeedIndex];topicAudio.playbackRate=e,speedButton.textContent=`${e}x`});
            loopButton.addEventListener("click",()=>{topicAudio.loop=!topicAudio.loop,loopButton.classList.toggle("active")});
            volumeSlider.addEventListener("input",e=>topicAudio.volume=e.target.value);
            topicAudio.addEventListener("volumechange",()=>{volumeSlider.value=topicAudio.volume,volumeIcon.className=topicAudio.muted||0===topicAudio.volume?"fas fa-volume-mute text-gray-500":topicAudio.volume<.5?"fas fa-volume-low text-gray-500":"fas fa-volume-high text-gray-500"});
            volumeIcon.addEventListener("click",()=>topicAudio.muted=!topicAudio.muted);
            document.addEventListener("click",e=>{chaptersMenuContainer.contains(e.target)||chaptersDropdown.classList.add("hidden")});
            
            editModeToggle.addEventListener("change",()=>{
                if (editModeToggle.checked) {
                    passwordModalOverlay.classList.remove('hidden');
                } else {
                    let isEditMode = false;
                    editorPanel.style.opacity = 0;
                    setTimeout(() => editorPanel.style.display = 'none', 300);
                    iframeContainer.className = "flex-1 transition-all duration-300";
                }
            });
            confirmEditButton.addEventListener('click', () => {
                if (passwordInput.value === "1234") {
                    let isEditMode = true;
                    editorPanel.style.display="block";
                    iframeContainer.className="w-full lg:w-2/3";
                    setTimeout(()=>editorPanel.style.opacity=1,10);
                    passwordModalOverlay.classList.add('hidden');
                    passwordInput.value = '';
                    passwordError.classList.add('hidden');
                } else {
                    passwordError.classList.remove('hidden');
                }
            });
            cancelEditButton.addEventListener('click', ()=> {
                 passwordModalOverlay.classList.add('hidden');
                 editModeToggle.checked = false;
                 passwordInput.value = '';
                 passwordError.classList.add('hidden');
            });
            passwordModalOverlay.addEventListener('click', (e) => { if (e.target === passwordModalOverlay) cancelEditButton.click(); });
            
            editorList.addEventListener("click",e=>{
                const t=e.target.closest(".mark-button, .delete-chapter-button");
                if(!t)return;
                const o=t.dataset.index;
                if(t.classList.contains("mark-button")){
                    const n=t.dataset.type,a=Math.round(100*topicAudio.currentTime)/100;
                    editedChapters[o][n]=a,document.getElementById(`${n}-time-${o}`).textContent=formatTime(a);
                } else t.classList.contains("delete-chapter-button")&&(editedChapters.splice(o,1),renderEditorList())
            });

            editorList.addEventListener('input', e => { if (e.target.tagName === 'INPUT' && e.target.type === 'text') editedChapters[e.target.dataset.index].title = e.target.value; });
            
            addChapterButton.addEventListener('click', () => {
                const newTitle = newChapterTitleInput.value.trim();
                if(newTitle) { editedChapters.push({ title: newTitle, start: 0 }); renderEditorList(); newChapterTitleInput.value = ''; }
            });

            saveDataButton.addEventListener("click",async()=>{
                const topicId = currentTopic.file.replace(/_desplegable\.html$/i, '');
                const docRef = doc(db, `artifacts/${appId}/users/${userId}/topics`, topicId);
                const dataToSave = { ...topics.find(t => t.file === currentTopic.file), chapters: editedChapters };
                saveIcon.className = "fas fa-spinner fa-spin",saveText.textContent = "Guardando...";
                try {
                    await setDoc(docRef, dataToSave);
                    const topicIndex = topics.findIndex(t => t.file === currentTopic.file);
                    if (topicIndex > -1) topics[topicIndex] = dataToSave;
                    saveNotification.style.opacity=1;
                    setTimeout(()=>{ saveNotification.style.opacity=0 }, 2000);
                    await updateChapters(currentTopic);
                } catch (error) {
                    console.error("Error al guardar en Firestore: ", error);
                    alert("No se pudo guardar los datos.");
                } finally {
                    saveIcon.className = "fas fa-cloud-upload-alt",saveText.textContent = "Guardar en la Nube";
                }
            });
        }
        
        main();
    </script>
</body>
</html>
